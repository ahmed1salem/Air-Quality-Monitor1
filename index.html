<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Content-Security-Policy"  
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://unpkg.com;
                   style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://unpkg.com https://fonts.googleapis.com; 
                   font-src 'self' https://fonts.gstatic.com; 
                   img-src 'self' https: data: blob: https://raw.githubusercontent.com https://placehold.co https://i.ibb.co https://images.unsplash.com;
                   connect-src 'self' https://api.waqi.info https://api.openweathermap.org https://api.openaq.org https://gibs.earthdata.nasa.gov https://generativelanguage.googleapis.com;">

    <title>Air Quality Monitor (AQM) - Live AQI & Pollution Map by Digital Minds</title>
    <meta name="description" content="Track real-time air quality and weather levels anywhere in the world. Get live AQI data, weather updates, and health recommendations with our interactive map, developed by the Digital Minds team.">
    <meta name="keywords" content="air quality, aqi, pollution, live map, air quality index, weather, real-time data, digital minds, web developer, portfolio">
    <meta name="author" content="Digital Minds">
    <link rel="canonical" href="https://air-quality-monitor-3.netlify.app" />

    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjk7K0IOVXn7WvuM8wl4rXWpCAvvMG8mUjenuSlZsBh6iUeoH8SlHd-dzzCdnIoSxHr6atY7R8fQKji1gIeZ282QhKL-QbXSEUaayoYuxFdtWtogbLhcBOwBAKWuKcolUYEzDxDd8xkgjP-ZSIsIS1DsSx_50DhHDoUp8LVN1hDsy-jHCJxn4vbPnoKnYE/s1260/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&family=Cairo:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="text-gray-200">

    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none"></div>
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 glass-panel z-40 transform -translate-x-full p-6">
        <button id="close-sidebar-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
        <div class="mt-8 space-y-4">
            <a href="#" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navHome">Home</a>
            <a href="#mission" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navMission">Our Mission</a>
            <a href="#aqi-guide" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navAqiGuide">AQI Guide</a>
            <a href="#map" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navMap">Map</a>
            <a href="#team" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navTeam">Our Team</a>
            <hr class="border-gray-700">
            <div class="space-y-4">
                <h3 class="font-bold text-lg text-white" data-lang-key="navSettings">Settings</h3>
                <div class="flex items-center justify-between">
                    <span class="text-gray-300" data-lang-key="navLanguage">Language</span>
                    <div class="flex space-x-1">
                        <button id="lang-en-sidebar" class="font-semibold text-sm py-1 px-2 rounded">EN</button>
                        <button id="lang-ar-sidebar" class="font-semibold text-sm py-1 px-2 rounded">AR</button>
                    </div>
                </div>
                 <div class="flex items-center justify-between">
                    <span class="text-gray-300" data-lang-key="navTheme">Theme</span>
                    <label class="switch">
                        <input type="checkbox" id="theme-switch-input">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <label for="talkback-toggle" class="text-gray-300" data-lang-key="navTalkback">Read on Hover</label>
                    <input type="checkbox" id="talkback-toggle" class="form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                </div>
            </div>
            <hr class="border-gray-700 my-4">
            <div class="space-y-2">
                <h3 class="font-bold text-lg text-white" data-lang-key="historyTitle">Search History</h3>
                <div id="history-list" class="space-y-1 max-h-32 overflow-y-auto text-sm">
                </div>
            </div>
        </div>
    </div>


    <div id="main-content">
        <header class="bg-black/30 backdrop-blur-sm fixed top-0 left-0 right-0 z-20">
            <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                <button id="menu-btn" class="text-white p-2 rounded-lg hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <a href="#" id="home-logo-link" class="flex items-center space-x-2">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjk7K0IOVXn7WvuM8wl4rXWpCAvvMG8mUjenuSlZsBh6iUeoH8SlHd-dzzCdnIoSxHr6atY7R8fQKji1gIeZ282QhKL-QbXSEUaayoYuxFdtWtogbLhcBOwBAKWuKcolUYEzDxDd8xkgjP-ZSIsIS1DsSx_50DhHDoUp8LVN1hDsy-jHCJxn4vbPnoKnYE/s1260/favicon.png" alt="Logo" class="h-8 w-8">
                    <h1 class="text-lg sm:text-xl font-bold text-white" data-lang-key="appName">Air Quality Monitor</h1>
                </a>
            </nav>
        </header>

        <div id="landing-page">
            <section class="hero-bg text-white pt-48 sm:pt-32 pb-20 text-center">
                <div id="stars1"></div>
                <div id="stars2"></div>
                <div id="stars3"></div>
                <div id="shooting-stars-container"></div>
                <div class="absolute inset-0 flex items-center justify-center opacity-40 z-0 pointer-events-none">
                    <div class="section-banner">
                        <div id="star-1">
                            <div class="curved-corner-star">
                                <div id="curved-corner-bottomright"></div>
                                <div id="curved-corner-bottomleft"></div>
                            </div>
                            <div class="curved-corner-star">
                                <div id="curved-corner-topright"></div>
                                <div id="curved-corner-topleft"></div>
                            </div>
                        </div>
                        <div id="star-2"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-3"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-4"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-5"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-6"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-7"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                    </div>
                </div>
                <div class="container mx-auto px-4 relative z-10 animate-on-scroll">
                    <h2 class="text-3xl sm:text-4xl md:text-6xl font-black mb-4 leading-tight uppercase" data-lang-key="heroTitle">Breathe Clearer. Live Better.</h2>
                    <p class="text-base sm:text-lg md:text-xl text-gray-300 mb-8 max-w-3xl mx-auto" data-lang-key="heroSubtitle">Your real-time guide to the air you breathe. We provide live, accurate air quality data to help you make healthier decisions every day.</p>
                    <a href="#map" id="launch-map-btn" class="glow-button text-white text-lg px-8 py-4 rounded-lg font-bold inline-block" data-lang-key="heroButton">Launch Live Map</a>
                </div>
            </section>
            
            <section id="about-features" class="py-20 bg-transparent">
                <div class="container mx-auto px-4">
                    <div class="text-center mb-16 animate-on-scroll">
                        <h2 class="text-3xl md:text-4xl font-bold text-white" data-lang-key="aboutTitle">A Comprehensive Tool for Your Well-being</h2>
                        <p class="text-gray-400 mt-4 max-w-3xl mx-auto" data-lang-key="aboutSubtitle">We combine air quality, weather data, and personalized features to give you a complete picture of your environment.</p>
                    </div>
            
                    <div class="space-y-16">
                        <div class="flex flex-wrap items-center animate-on-scroll">
                            <div class="w-full md:w-1/2 lg:w-5/12 px-4 md:pr-8">
                                <div class="p-3 text-indigo-400 bg-indigo-900/50 rounded-full inline-block mb-4">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                <h3 class="text-2xl font-bold mb-3 text-white" data-lang-key="feature1Title">Live Interactive Map</h3>
                                <p class="text-gray-400" data-lang-key="feature1Desc">Our core feature is a dynamic world map. Click anywhere to get instant, real-time Air Quality Index (AQI) data from the nearest monitoring station. Track pollution levels in your city or anywhere you plan to travel.</p>
                            </div>
                            <div class="w-full md:w-1/2 lg:w-7/12 mt-8 md:mt-0">
                                <img src="https://i.ibb.co/LXpVrpH5/image.png" alt="Planet from space" class="rounded-lg shadow-2xl shadow-indigo-900/50">
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center flex-col-reverse md:flex-row-reverse animate-on-scroll">
                            <div class="w-full md:w-1/2 lg:w-5/12 px-4 md:pl-8 mt-8 md:mt-0">
                                <div class="p-3 text-green-400 bg-green-900/50 rounded-full inline-block mb-4">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <h3 class="text-2xl font-bold mb-3 text-white" data-lang-key="feature2Title">Detailed Data & Weather</h3>
                                <p class="text-gray-400" data-lang-key="feature2Desc">Beyond the AQI number, our detailed panel shows you crucial weather information like temperature, humidity, and wind speed. This helps you understand how weather conditions affect air quality.</p>
                            </div>
                            <div class="w-full md:w-1/2 lg:w-7/12">
                                <img src="https://i.ibb.co/KpvVQpNZ/image.png" alt="Futuristic data dashboard" class="rounded-lg shadow-2xl shadow-indigo-900/50">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="mission" class="py-20 bg-transparent">
                <div class="container mx-auto px-4">
                    <div class="glass-panel rounded-lg p-8 md:p-12 animate-on-scroll">
                        <div class="text-center">
                            <h2 class="text-3xl md:text-4xl font-bold text-white mb-2" data-lang-key="missionTitle">Our Mission: Earth's Health from a Celestial View</h2>
                            <p class="text-lg text-indigo-300 mb-2" data-lang-key="missionSubtitle">A NASA Space Apps Challenge 2025 Project</p>
                            <p class="text-gray-400 italic mt-2 mb-6 max-w-3xl mx-auto" data-lang-key="missionChallengeName"></p>
                            <p class="text-gray-300 max-w-4xl mx-auto mb-4" data-lang-key="missionDesc">This project was born out of the NASA Space Apps Challenge Cairo 2025, marking the 11th local edition of this global event. Our goal is to leverage the power of data, inspired by space exploration, to bring crucial environmental information to your fingertips. By monitoring air quality, we aim to foster a healthier relationship between humanity and our home planet.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="aqi-guide" class="py-20 bg-transparent">
                <div class="container mx-auto px-4">
                    <div class="text-center mb-16 animate-on-scroll">
                        <h2 class="text-3xl md:text-4xl font-bold text-white" data-lang-key="aqiGuideTitle">Understanding the Air Quality Index (AQI)</h2>
                        <p class="text-gray-400 mt-4 max-w-3xl mx-auto" data-lang-key="aqiGuideDesc">The AQI is your guide to understanding how clean or polluted the air is. Here's a quick breakdown of the levels:</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
                    </div>
                </div>
            </section>

            <section id="team" class="py-20 bg-transparent">
                 <div class="container mx-auto px-4">
                    <div class="text-center mb-16 animate-on-scroll">
                        <h2 class="text-3xl md:text-4xl font-bold text-white" data-lang-key="teamTitle">Meet Our Team</h2>
                        <p class="text-lg text-gray-400 mt-2 italic" data-lang-key="teamSlogan">Together, we build solutions for a better tomorrow.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl mx-auto">
                    </div>
                </div>
            </section>

        </div>
        
        <div id="page-content" class="hidden pt-20">
        </div>

        <div id="map-view" class="hidden">
             <div id="map-container" class="relative">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <footer class="bg-black/30 py-6 text-center text-gray-400 border-t border-gray-800">
        <div class="container mx-auto px-4">
            <p data-lang-key="footerText">&copy; 2024 All rights reserved for Digital Minds team</p>
        </div>
    </footer>

    <button type="button" id="ai-assistant-btn" class="button fixed bottom-6 right-6 z-[1500]">
        <span class="fold"></span>
        <div class="points_wrapper">
            <i class="point"></i>
            <i class="point"></i>
            <i class="point"></i>
            <i class="point"></i>
            <i class="point"></i>
            <i class="point"></i>
            <i class="point"></i>
            <i class="point"></i>
            <i class="point"></i>
            <i class="point"></i>
        </div>
        <span class="inner">
            <svg
                class="icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2.5"
            >
                <polyline
                points="13.18 1.37 13.18 9.64 21.45 9.64 10.82 22.63 10.82 14.36 2.55 14.36 13.18 1.37"
                ></polyline>
            </svg>
            AI
        </span>
    </button>

    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[2000] flex justify-center items-center hidden">
        <div class="glass-panel p-6 rounded-lg w-full max-w-lg h-[80vh] flex flex-col mx-4 relative">
            <button id="close-ai-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-center text-white" data-lang-key="aiAssistantTitle">AI Assistant</h3>
            <div id="ai-chat-window" class="flex-grow bg-gray-900/50 rounded-lg p-4 overflow-y-auto mb-4">
            </div>
            <div id="ai-loading-indicator" class="hidden flex justify-center items-center mb-2 h-12">
                <div class="loading" style="height: 50px;">
                  <span></span>
                  <span></span>
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
            </div>
            <div id="ai-context-actions" class="flex justify-center space-x-2 mb-2">
                <button id="get-forecast-btn" class="text-sm bg-indigo-800 hover:bg-indigo-700 text-white py-1 px-3 rounded-full hidden" data-lang-key="getForecast">Get Forecast</button>
                <button id="health-profile-btn" class="text-sm bg-green-800 hover:bg-green-700 text-white py-1 px-3 rounded-full" data-lang-key="myHealth">My Health</button>
            </div>
            <div id="health-profile-section" class="hidden p-2 bg-gray-800/50 rounded-lg mb-2">
                <p class="text-sm text-center text-gray-300 mb-2" data-lang-key="healthProfilePrompt">Select any conditions for personalized advice:</p>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="Asthma" class="health-condition form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                        <span data-lang-key="healthAsthma">Asthma</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="Allergies" class="health-condition form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                        <span data-lang-key="healthAllergies">Allergies</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="Heart Condition" class="health-condition form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                        <span data-lang-key="healthHeart">Heart Condition</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="Lung Condition" class="health-condition form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                        <span data-lang-key="healthLungs">Lung Condition</span>
                    </label>
                </div>
            </div>
            <form id="ai-input-form" class="flex items-center">
                <input id="ai-user-input" type="text" class="w-full p-3 rounded-lg modal-input" required placeholder="Ask about weather, AQI, or health advice..." data-lang-key="aiPlaceholder">
                <button type="submit" class="ml-3 p-3 rounded-lg glow-button">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2.925 3.555l14.15 6.445a.5.5 0 010 .9l-14.15 6.445a.5.5 0 01-.825-.45V3.905a.5.5 0 01.825-.35z"></path></svg>
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        const GEMINI_API_KEY = "AIzaSyDgd0sCe4CXWO6e7rqJufMwdbcTCFHNsco";

        const teamMembers = [
            { name: "Ahmed Salem Khalifa", role: "Team Lead & LLM Specialist", desc: "Responsible for the overall project vision, managing the development timeline, and coordinating the team's tasks. His expertise as an LLM Specialist will guide any future integrations of AI-powered features.", img: "https://i.ibb.co/RGtFVr0L/IMG-20241204-WA0010-Copy.jpg" },
            { name: "Roqaya Mohamed Ahmed", role: "Business Strategist & Frontend Developer", desc: "Responsible for aligning the project with market needs and developing the business strategy. She will also contribute to frontend development, focusing on a user-friendly interface.", img: "https://i.ibb.co/VZpYzy3/Whats-App-Image-2025-09-26-at-15-55-43-eed85144.jpg" },
            { name: "Ahmed Essam Wagdy", role: "Frontend Developer & Researcher", desc: "Responsible for implementing core features like the interactive map and API integrations. His research skills are crucial for finding the best technical solutions.", img: "https://i.ibb.co/rKYQGD4k/Whats-App-Image-2025-09-26-at-1-11-41-AM.jpg" },
            { name: "Loay Ahmed Abo El-Maty", role: "Frontend Developer & Researcher", desc: "Responsible for developing features such as the animated weather graphics. He will also conduct research to support the technical implementation.", img: "https://i.ibb.co/39htsQ0s/Whats-App-Image-2025-09-24-at-11-41-20-PM.jpg" },
            { name: "Ziad Mohamed Hamdy", role: "Social Media Specialist", desc: "Responsible for managing the project's public presence and communication strategy. He will handle social media updates and community engagement to build awareness.", img: "https://i.ibb.co/mC62Nmx9/Whats-App-Image-2025-09-26-at-6-59-23-PM.jpg" },
        ];


        const translations = {
            en: {
                appName: "Air Quality Monitor",
                navLogin: "Login",
                navSignup: "Sign Up",
                navHome: "Home",
                navMap: "Map",
                navTeam: "Our Team",
                navMission: "Our Mission",
                navAqiGuide: "AQI Guide",
                navSettings: "Settings",
                navLanguage: "Language",
                navTheme: "Theme",
                navTalkback: "Read on Hover",
                heroTitle: "Breathe Clearer. Live Better.",
                heroSubtitle: "Your real-time guide to the air you breathe. We provide live, accurate air quality data to help you make healthier decisions every day.",
                heroButton: "Launch Live Map",
                teamTitle: "Meet Our Team",
                teamSlogan: "Together, we build solutions for a better tomorrow.",
                missionTitle: "Our Mission: Earth's Health from a Celestial View",
                missionSubtitle: "A NASA Space Apps Challenge 2025 Project",
                missionChallengeName: "From EarthData to Action: Cloud Computing with Earth Observation Data for Predicting Cleaner, Safer Skies",
                missionDesc: "This project was born out of the NASA Space Apps Challenge Cairo 2025, marking the 11th local edition of this global event. Our goal is to leverage the power of data, inspired by space exploration, to bring crucial environmental information to your fingertips. By monitoring air quality, we aim to foster a healthier relationship between humanity and our home planet.",
                aqiGuideTitle: "Understanding the Air Quality Index (AQI)",
                aqiGuideDesc: "The AQI is your guide to understanding how clean or polluted the air is. Here's a quick breakdown of the levels:",
                namePlaceholder: "Full Name",
                emailPlaceholder: "Email",
                passwordPlaceholder: "Password",
                loginTitle: "Login to Your Account",
                loginButton: "Login",
                noAccount: "Don't have an account?",
                signupLink: "Sign up",
                signupTitle: "Create a New Account",
                signupButton: "Sign Up",
                hasAccount: "Already have an account?",
                loginLink: "Login",
                forgotPasswordLink: "Forgot Password?",
                forgotPasswordTitle: "Reset Password",
                forgotPasswordInstructions: "Enter your email and we'll send you a link to reset your password.",
                sendResetLinkButton: "Send Reset Link",
                resetEmailSent: "Password reset email sent! Please check your inbox and spam folder.",
                changePasswordTitle: "Change Password",
                currentPasswordPlaceholder: "Current Password for verification",
                newPasswordPlaceholder: "New Password (min. 6 characters)",
                changePasswordButton: "Update Password",
                passwordUpdateSuccess: "Password updated successfully!",
                passwordUpdateError: "Incorrect current password. Please try again.",
                menuEditProfile: "Edit Profile",
                editProfileTitle: "Edit Profile",
                editEmailInstructions: "To change your email, please enter your current password.",
                saveChangesButton: "Save Changes",
                profileUpdateSuccess: "Profile updated successfully!",
                menuHistory: "Search History",
                menuChangePassword: "Change Password",
                menuLogout: "Logout",
                searchPlaceholder: "Search for a city or place...",
                historyTitle: "Search History",
                noHistory: "Your search history is empty.",
                aboutTitle: "A Comprehensive Tool for Your Well-being",
                aboutSubtitle: "We combine air quality, weather data, and personalized features to give you a complete picture of your environment.",
                feature1Title: "Live Interactive Map",
                feature1Desc: "Our core feature is a dynamic world map. Click anywhere to get instant, real-time Air Quality Index (AQI) data from the nearest monitoring station. Track pollution levels in your city or anywhere you plan to travel.",
                feature2Title: "Detailed Data & Weather",
                feature2Desc: "Beyond the AQI number, our detailed panel shows you crucial weather information like temperature, humidity, and wind speed. This helps you understand how weather conditions affect air quality.",
                dataPanelAQI: "Air Quality Index (AQI)",
                dataPanelTemp: "Temp",
                dataPanelHumidity: "Humidity",
                dataPanelWind: "Wind",
                dataPanelHealthAdvice: "Health Advice:",
                updatedLabel: "Updated",
                footerText: "© 2024 All rights reserved for Digital Minds team",
                aqiStatusGood: "Good",
                aqiAdviceGood: "Air quality is excellent. Great day to be active outside!",
                aqiStatusModerate: "Moderate",
                aqiAdviceModerate: "Air quality is acceptable. Sensitive individuals may have symptoms.",
                aqiStatusUnhealthySensitive: "Unhealthy for Sensitive",
                aqiAdviceUnhealthySensitive: "Sensitive groups should reduce heavy exertion outdoors.",
                aqiStatusUnhealthy: "Unhealthy",
                aqiAdviceUnhealthy: "Everyone should reduce heavy exertion outdoors.",
                aqiStatusVeryUnhealthy: "Very Unhealthy",
                aqiAdviceVeryUnhealthy: "Health alert: Avoid all outdoor physical activity.",
                aqiStatusHazardous: "Hazardous",
                aqiAdviceHazardous: "Health warning: Everyone should stay indoors.",
                aqiStatusNoData: "No Data",
                aqiError: "AQI data not available for this location.",
                fetchError: "Failed to fetch all data. Please try again.",
                errorTitle: "Error",
                aiAssistantTitle: "AI Assistant",
                aiTyping: "AI is typing...",
                aiPlaceholder: "Ask about weather, AQI, or health advice...",
                getForecast: "Get Forecast",
                myHealth: "My Health",
                healthProfilePrompt: "Select any conditions for personalized advice:",
                healthAsthma: "Asthma",
                healthAllergies: "Allergies",
                healthHeart: "Heart Condition",
                healthLungs: "Lung Condition",
            },
            ar: {
                appName: "مراقب جودة الهواء",
                navLogin: "تسجيل الدخول",
                navSignup: "حساب جديد",
                navHome: "الرئيسية",
                navMap: "الخريطة",
                navTeam: "فريقنا",
                navMission: "مهمتنا",
                navAqiGuide: "دليل جودة الهواء",
                navSettings: "الإعدادات",
                navLanguage: "اللغة",
                navTheme: "المظهر",
                navTalkback: "القراءة عند المرور",
                heroTitle: "تنفس أنقى. عش أفضل.",
                heroSubtitle: "دليلك الفوري لجودة الهواء الذي تتنفسه. نحن نقدم بيانات دقيقة ومباشرة لمساعدتك على اتخاذ قرارات صحية كل يوم.",
                heroButton: "افتح الخريطة المباشرة",
                teamTitle: "تعرف على فريقنا",
                teamSlogan: "معًا، نبني حلولًا من أجل غد أفضل.",
                missionTitle: "مهمتنا: صحة الأرض من منظور سماوي",
                missionSubtitle: "مشروع مقدم لتحدي NASA Space Apps لعام 2025",
                missionChallengeName: "من بيانات الأرض إلى العمل: الحوسبة السحابية مع بيانات مراقبة الأرض للتنبؤ بسماء أنظف وأكثر أمانًا",
                missionDesc: "وُلد هذا المشروع من رحم تحدي NASA Space Apps القاهرة 2025، والذي يمثل النسخة المحلية الحادية عشرة من هذا الحدث العالمي. هدفنا هو تسخير قوة البيانات، المستوحاة من استكشاف الفضاء، لوضع المعلومات البيئية الحيوية في متناول يدك. من خلال مراقبة جودة الهواء، نطمح إلى تعزيز علاقة صحية بين الإنسانية وكوكبنا الأم.",
                aqiGuideTitle: "فهم مؤشر جودة الهواء (AQI)",
                aqiGuideDesc: "مؤشر جودة الهواء هو دليلك لفهم مدى نقاء أو تلوث الهواء. إليك شرح سريع للمستويات:",
                namePlaceholder: "الاسم الكامل",
                emailPlaceholder: "البريد الإلكتروني",
                passwordPlaceholder: "كلمة المرور",
                loginTitle: "تسجيل الدخول إلى حسابك",
                loginButton: "دخول",
                noAccount: "ليس لديك حساب؟",
                signupLink: "أنشئ حسابًا",
                signupTitle: "إنشاء حساب جديد",
                signupButton: "إنشاء حساب",
                hasAccount: "هل لديك حساب بالفعل؟",
                loginLink: "تسجيل الدخول",
                forgotPasswordLink: "هل نسيت كلمة المرور؟",
                forgotPasswordTitle: "إعادة تعيين كلمة المرور",
                forgotPasswordInstructions: "أدخل بريدك الإلكتروني وسنرسل لك رابطًا لإعادة تعيين كلمة المرور.",
                sendResetLinkButton: "أرسل رابط الاستعادة",
                resetEmailSent: "تم إرسال بريد إعادة تعيين كلمة المرور! يرجى التحقق من بريدك الوارد ومجلد الرسائل غير المرغوب فيها (Spam).",
                changePasswordTitle: "تغيير كلمة المرور",
                currentPasswordPlaceholder: "كلمة المرور الحالية للتحقق",
                newPasswordPlaceholder: "كلمة المرور الجديدة (6 أحرف على الأقل)",
                changePasswordButton: "تحديث كلمة المرور",
                passwordUpdateSuccess: "تم تحديث كلمة المرور بنجاح!",
                passwordUpdateError: "كلمة المرور الحالية غير صحيحة. يرجى المحاولة مرة أخرى.",
                menuEditProfile: "تعديل الملف الشخصي",
                editProfileTitle: "تعديل الملف الشخصي",
                saveChangesButton: "حفظ التغييرات",
                profileUpdateSuccess: "تم تحديث الملف الشخصي بنجاح!",
                menuHistory: "سجل البحث",
                menuChangePassword: "تغيير كلمة المرور",
                menuLogout: "تسجيل الخروج",
                searchPlaceholder: "ابحث عن مدينة أو مكان...",
                historyTitle: "سجل البحث",
                noHistory: "سجل البحث الخاص بك فارغ.",
                aboutTitle: "أداة شاملة لرفاهيتك",
                aboutSubtitle: "نحن نجمع بين بيانات جودة الهواء والطقس والميزات المخصصة لنمنحك صورة كاملة عن بيئتك.",
                feature1Title: "خريطة تفاعلية مباشرة",
                feature1Desc: "ميزتنا الأساسية هي خريطة عالمية ديناميكية. انقر في أي مكان للحصول على بيانات مؤشر جودة الهواء (AQI) الفورية في الوقت الفعلي من أقرب محطة مراقبة. تتبع مستويات التلوث في مدينتك أو أي مكان تخطط للسفر إليه.",
                feature2Title: "بيانات مفصلة والطقس",
                feature2Desc: "إلى جانب رقم مؤشر جودة الهواء، تعرض لك لوحة البيانات التفصيلية معلومات الطقس الهامة مثل درجة الحرارة والرطوبة وسرعة الرياح. يساعدك هذا على فهم كيفية تأثير الظروف الجوية على جودة الهواء.",
                dataPanelAQI: "مؤشر جودة الهواء",
                dataPanelTemp: "الحرارة",
                dataPanelHumidity: "الرطوبة",
                dataPanelWind: "الرياح",
                dataPanelHealthAdvice: "نصيحة صحية:",
                updatedLabel: "آخر تحديث",
                footerText: "© 2024 جميع الحقوق محفوظة لفريق Digital Minds",
                aqiStatusGood: "جيد",
                aqiAdviceGood: "جودة الهواء ممتازة. يوم رائع للنشاط في الخارج!",
                aqiStatusModerate: "متوسط",
                aqiAdviceModerate: "جودة الهواء مقبولة. قد يعاني الأفراد الحساسون من أعراض.",
                aqiStatusUnhealthySensitive: "غير صحي للحساسين",
                aqiAdviceUnhealthySensitive: "يجب على المجموعات الحساسة تقليل المجهود الشاق في الهواء الطلق.",
                aqiStatusUnhealthy: "غير صحي",
                aqiAdviceUnhealthy: "يجب على الجميع تقليل المجهود الشاق في الهواء الطلق.",
                aqiStatusVeryUnhealthy: "غير صحي للغاية",
                aqiAdviceVeryUnhealthy: "تنبيه صحي: تجنب كل الأنشطة البدنية في الهواء الطلق.",
                aqiStatusHazardous: "خطير",
                aqiAdviceHazardous: "تحذير صحي: يجب على الجميع البقاء في الداخل.",
                aqiStatusNoData: "لا توجد بيانات",
                aqiError: "بيانات جودة الهواء غير متوفرة لهذا الموقع.",
                fetchError: "فشل جلب جميع البيانات. يرجى المحاولة مرة أخرى.",
                errorTitle: "خطأ",
                aiAssistantTitle: "المساعد الذكي",
                aiTyping: "الذكاء الاصطناعي يكتب...",
                aiPlaceholder: "اسأل عن الطقس، جودة الهواء، أو نصائح صحية...",
                getForecast: "احصل على التوقعات",
                myHealth: "حالتي الصحية",
                healthProfilePrompt: "اختر أي حالة للحصول على نصائح مخصصة:",
                healthAsthma: "الربو",
                healthAllergies: "الحساسية",
                healthHeart: "أمراض القلب",
                healthLungs: "أمراض الرئة",
            }
        };

        async function askGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            const headers = { 'Content-Type': 'application/json' };
            const body = JSON.stringify({
                contents: [{
                    parts: [{ text: prompt }]
                }]
            });

            try {
                const response = await fetch(url, { method: 'POST', headers, body });
                if (!response.ok) {
                    console.error("Gemini API Error:", response.status, await response.text());
                    return "Sorry, I'm having trouble connecting to my brain right now. Please try again later.";
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "An error occurred while trying to reach the AI assistant.";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            const landingPage = document.getElementById('landing-page');
            const pageContent = document.getElementById('page-content');
            const mapView = document.getElementById('map-view');
            const mapContainer = document.getElementById('map-container');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const menuBtn = document.getElementById('menu-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const themeSwitch = document.getElementById('theme-switch-input');
            const talkbackToggle = document.getElementById('talkback-toggle');

            const aiAssistantBtn = document.getElementById('ai-assistant-btn');
            const aiModal = document.getElementById('ai-modal');
            const closeAiModalBtn = document.getElementById('close-ai-modal');
            const aiChatWindow = document.getElementById('ai-chat-window');
            const aiInputForm = document.getElementById('ai-input-form');
            const aiUserInput = document.getElementById('ai-user-input');
            const aiLoadingIndicator = document.getElementById('ai-loading-indicator');
            const getForecastBtn = document.getElementById('get-forecast-btn');
            const healthProfileBtn = document.getElementById('health-profile-btn');
            const healthProfileSection = document.getElementById('health-profile-section');

            let mapInitialized = false;
            let map = null;
            let currentLocationData = null; // For AI context
            let speechVoices = [];
            let isTalkbackEnabled = false;
            let currentHighlight = null;
            const allViews = [landingPage, mapView, pageContent];
            const pageViews = {}; // Team page is now on landing page
            const landingPageAnchors = ['#mission', '#aqi-guide', '#about-features', '#team'];
            const historyList = document.getElementById('history-list');

            let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];

            function renderSearchHistory() {
                if (!historyList) return;
                historyList.innerHTML = '';
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';

                if (searchHistory.length === 0) {
                    const noHistoryEl = document.createElement('p');
                    noHistoryEl.className = 'text-gray-400 italic text-xs';
                    noHistoryEl.setAttribute('data-lang-key', 'noHistory');
                    noHistoryEl.textContent = translations[currentLang].noHistory;
                    historyList.appendChild(noHistoryEl);
                    return;
                }

                searchHistory.slice().reverse().forEach(item => { // Show history, newest first
                    const historyItem = document.createElement('a');
                    historyItem.href = '#map';
                    historyItem.className = 'block text-gray-400 hover:text-indigo-300 truncate p-1 rounded hover:bg-gray-700/50 cursor-pointer';
                    historyItem.textContent = item.name;
                    historyItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.location.hash = '#map';
                        setTimeout(() => {
                            if (map) {
                                map.setView([item.lat, item.lng], 13);
                                fetchAllDataForLocation(item.lat, item.lng);
                            }
                        }, 100);
                        closeSidebar();
                    });
                    historyList.appendChild(historyItem);
                });
            }

            function saveSearchToHistory(searchItem) {
                const existingIndex = searchHistory.findIndex(item =>
                    item.lat.toFixed(4) === searchItem.lat.toFixed(4) &&
                    item.lng.toFixed(4) === searchItem.lng.toFixed(4)
                );

                if (existingIndex > -1) {
                    searchHistory.splice(existingIndex, 1);
                }

                searchHistory.push(searchItem);

                // Keep the history list to a maximum of 10 items.
                if (searchHistory.length > 10) {
                    searchHistory.shift(); // Removes the oldest item.
                }

                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                renderSearchHistory();
            }

            const openAiModal = () => {
                aiModal.classList.remove('hidden');
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                const welcomeMessage = currentLang === 'ar'
                    ? "أهلاً بك! يمكنك سؤالي عن توقعات الطقس وجودة الهواء، أو طلب نصائح صحية شخصية بناءً على البيانات المتاحة."
                    : "Welcome! Ask me for a weather and air quality forecast, or for personalized health advice based on the data.";
                appendMessage(welcomeMessage, "ai");
            };

            const closeAiModal = () => {
                aiModal.classList.add('hidden');
                aiChatWindow.innerHTML = ''; // Clear chat history on close
            };

            const appendMessage = (text, sender) => {
                const messageDiv = document.createElement('div');
                const bubbleDiv = document.createElement('div');
                bubbleDiv.textContent = text;
                bubbleDiv.className = `p-3 rounded-lg max-w-[85%] ${sender === 'user' ? 'bg-indigo-600 text-white self-end' : 'bg-gray-700 text-gray-200 self-start'}`;
                messageDiv.className = 'flex flex-col mb-3';
                messageDiv.appendChild(bubbleDiv);
                aiChatWindow.appendChild(messageDiv);
                aiChatWindow.scrollTop = aiChatWindow.scrollHeight; // Auto-scroll
            };

            healthProfileBtn.addEventListener('click', () => {
                healthProfileSection.classList.toggle('hidden');
            });

            aiInputForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = aiUserInput.value.trim();
                if (!userInput) return;

                appendMessage(userInput, 'user');
                aiUserInput.value = '';
                aiLoadingIndicator.classList.remove('hidden');

                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                const langInstructions = currentLang === 'ar'
                    ? 'The user prefers Arabic. Your entire response must be in Arabic.'
                    : 'The user prefers English. Your entire response must be in English.';

                const selectedConditions = Array.from(document.querySelectorAll('.health-condition:checked')).map(cb => cb.value);

                let systemPrompt = "You are a helpful AI assistant for the 'Air Quality Monitor' web application. Your role is to interpret environmental data and provide clear, actionable advice. Be friendly and encouraging.";

                let contextPrompt = "";
                if (currentLocationData) {
                    const { aqiData, weatherData } = currentLocationData;
                    const aqi = aqiData?.aqi || 'N/A';
                    const temp = weatherData?.main?.temp ? `${Math.round(weatherData.main.temp)}°C` : 'N/A';
                    const weather = weatherData?.weather?.[0]?.description || 'N/A';
                    const city = weatherData?.name || aqiData?.city?.name || 'the current location';
                    contextPrompt = `The user is currently viewing data for ${city}. The Air Quality Index (AQI) is ${aqi}. The weather is ${weather} with a temperature of ${temp}.`;
                } else {
                    contextPrompt = "The user has not selected a location on the map yet.";
                }

                let userPrompt = `The user's question is: "${userInput}".`;
                if (selectedConditions.length > 0) {
                    const conditionsText = selectedConditions.join(', ');
                    userPrompt += ` They have indicated the following health conditions: ${conditionsText}. Please tailor your advice accordingly.`;
                }

                const fullPrompt = `${systemPrompt}\n\n${contextPrompt}\n\n${userPrompt}\n\n${langInstructions}`;

                const aiResponse = await askGemini(fullPrompt);

                aiLoadingIndicator.classList.add('hidden');
                appendMessage(aiResponse, 'ai');
            });

            aiAssistantBtn.addEventListener('click', openAiModal);
            closeAiModalBtn.addEventListener('click', closeAiModal);

            getForecastBtn.addEventListener('click', async () => {
                if (!currentLocationData) {
                    appendMessage("Please select a location on the map first to get a forecast.", "ai");
                    return;
                }

                const { aqiData, weatherData } = currentLocationData;
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                const langInstructions = currentLang === 'ar' ? 'Please provide the forecast in Arabic.' : 'Please provide the forecast in English.';

                const prompt = `
                    Based on the following real-time data for ${weatherData?.name || 'the selected location'}:
                    - Air Quality Index (AQI): ${aqiData?.aqi || 'N/A'}
                    - Temperature: ${weatherData?.main?.temp ? Math.round(weatherData.main.temp) + '°C' : 'N/A'}
                    - Weather: ${weatherData?.weather?.[0]?.description || 'N/A'}
                    - Humidity: ${weatherData?.main?.humidity ? weatherData.main.humidity + '%' : 'N/A'}
                    - Wind Speed: ${weatherData?.wind?.speed ? Math.round(weatherData.wind.speed * 3.6) + ' km/h' : 'N/A'}

                    Please provide a simple, user-friendly forecast for the next 24 hours. Include predictions for air quality and weather. Also, give one or two general health recommendations based on this data.
                    ${langInstructions}
                `;

                const forecastRequestText = currentLang === 'ar' ? 'جاري إنشاء التوقعات بناءً على البيانات الحالية...' : 'Generating forecast based on current data...';
                appendMessage(forecastRequestText, 'user');
                aiLoadingIndicator.classList.remove('hidden');

                const aiResponse = await askGemini(prompt);

                aiLoadingIndicator.classList.add('hidden');
                appendMessage(aiResponse, 'ai');
            });


            function loadVoices() {
                speechVoices = speechSynthesis.getVoices();
            }
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }

            function renderTeam() {
                const teamContainer = document.querySelector('#team .grid');
                if(!teamContainer) return;
                teamContainer.innerHTML = ''; // Clear existing
                teamMembers.forEach((member, index) => {
                    const card = document.createElement('div');
                    card.className = "team-card glass-panel p-6 rounded-lg text-center animate-on-scroll";
                    card.style.transitionDelay = `${index * 100}ms`;
                    card.innerHTML = `
                        <img src="${member.img}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/E2E8F0/4A5568?text=${member.name.charAt(0)}';" alt="Photo of ${member.name}" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-indigo-500/50 object-cover">
                        <h3 class="text-xl font-bold text-white">${member.name}</h3>
                        <p class="text-indigo-400 font-semibold">${member.role}</p>
                        <p class="text-gray-400 mt-2 text-sm">${member.desc}</p>
                    `;
                    teamContainer.appendChild(card);
                });
            }

            function renderAqiGuide() {
                const aqiContainer = document.querySelector('#aqi-guide .grid');
                if (!aqiContainer) return;
                aqiContainer.innerHTML = '';
                const aqiLevels = [
                    { range: '0 - 50', statusKey: 'aqiStatusGood', adviceKey: 'aqiAdviceGood', color: '#22c55e' },
                    { range: '51 - 100', statusKey: 'aqiStatusModerate', adviceKey: 'aqiAdviceModerate', color: '#facc15' },
                    { range: '101 - 150', statusKey: 'aqiStatusUnhealthySensitive', adviceKey: 'aqiAdviceUnhealthySensitive', color: '#f97316' },
                    { range: '151 - 200', statusKey: 'aqiStatusUnhealthy', adviceKey: 'aqiAdviceUnhealthy', color: '#ef4444' },
                    { range: '201 - 300', statusKey: 'aqiStatusVeryUnhealthy', adviceKey: 'aqiAdviceVeryUnhealthy', color: '#a855f7' },
                    { range: '301+', statusKey: 'aqiStatusHazardous', adviceKey: 'aqiAdviceHazardous', color: '#7f1d1d' },
                ];
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';

                aqiLevels.forEach((level, index) => {
                    const card = document.createElement('div');
                    card.className = 'glass-panel p-4 rounded-lg aqi-level-card animate-on-scroll';
                    card.style.borderColor = level.color;
                    card.style.transitionDelay = `${index * 100}ms`;
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <p class="font-bold text-lg text-white">${translations[currentLang][level.statusKey]}</p>
                            <p class="font-black text-xl" style="color: ${level.color};">${level.range}</p>
                        </div>
                        <p class="text-gray-400 text-sm">${translations[currentLang][level.adviceKey]}</p>
                    `;
                    aqiContainer.appendChild(card);
                });
            }
            
            const shootingStarsContainer = document.getElementById('shooting-stars-container');
            if (shootingStarsContainer) {
                const numberOfStars = 15;
                for (let i = 0; i < numberOfStars; i++) {
                    let star = document.createElement('div');
                    star.classList.add('shooting-star');
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 10}s`;
                    star.style.animationDuration = `${(Math.random() * 2) + 1}s`; // Duration between 1s and 3s
                    shootingStarsContainer.appendChild(star);
                }
            }
            
            renderTeam();
            renderAqiGuide();
            
            const applyTheme = (theme) => {
                if (theme === 'light') {
                    document.documentElement.classList.add('light');
                    themeSwitch.checked = true;
                } else { // 'dark' is default
                    document.documentElement.classList.remove('light');
                    themeSwitch.checked = false;
                }
            };

            const toggleTheme = () => {
                const newTheme = themeSwitch.checked ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            };

            themeSwitch.addEventListener('change', toggleTheme);

            const initialTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(initialTheme);
            
            const sanitizeInput = (input) => {
                const div = document.createElement('div');
                div.textContent = input;
                return div.innerHTML;
            };

            const setLanguage = (lang) => {
                speechSynthesis.cancel();
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                
                document.body.classList.remove('lang-en', 'lang-ar');
                document.body.classList.add('lang-' + lang);

                document.querySelectorAll('[data-lang-key]').forEach(element => {
                    const key = element.getAttribute('data-lang-key');
                    const translation = translations[lang][key];
                    if (translation) {
                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            element.setAttribute('placeholder', translation);
                        } else {
                            element.textContent = translation;
                        }
                    }
                });
                
                if (map) {
                    const geocoderControl = document.querySelector('.leaflet-control-geocoder-form input');
                    if (geocoderControl) {
                        geocoderControl.placeholder = translations[lang].searchPlaceholder;
                    }
                }
                
                renderAqiGuide(); // Re-render AQI guide with new language
                renderSearchHistory(); // Re-render search history with new language
                localStorage.setItem('preferredLanguage', lang);
                updateLangButtons(lang);
            };

            const updateLangButtons = (lang) => {
                const langEnBtnSidebar = document.getElementById('lang-en-sidebar');
                const langArBtnSidebar = document.getElementById('lang-ar-sidebar');
                if (lang === 'ar') {
                    langArBtnSidebar.classList.add('bg-indigo-600', 'text-white');
                    langEnBtnSidebar.classList.remove('bg-indigo-600', 'text-white');
                } else {
                    langEnBtnSidebar.classList.add('bg-indigo-600', 'text-white');
                    langArBtnSidebar.classList.remove('bg-indigo-600', 'text-white');
                }
            };
            
            document.getElementById('lang-en-sidebar').addEventListener('click', () => setLanguage('en'));
            document.getElementById('lang-ar-sidebar').addEventListener('click', () => setLanguage('ar'));
            
            const preferredLanguage = localStorage.getItem('preferredLanguage') || 'en';
            setLanguage(preferredLanguage);
            renderSearchHistory();

            const scrollElements = document.querySelectorAll('.animate-on-scroll');
            const elementInView = (el, offset = 0) => {
                const elementTop = el.getBoundingClientRect().top;
                return (
                    elementTop <= 
                    (window.innerHeight || document.documentElement.clientHeight) - offset
                );
            };

            const handleScrollAnimation = () => {
                scrollElements.forEach((el) => {
                    if(elementInView(el, 100)) {
                        el.classList.add('is-visible');
                    }
                })
            }
            window.addEventListener('scroll', handleScrollAnimation);


            function showPage(hash) {
                speechSynthesis.cancel();
                allViews.forEach(v => v.classList.add('hidden'));
                Object.values(pageViews).forEach(v => v.classList.add('hidden'));
                
                if (hash === '#map') {
                    mapView.classList.remove('hidden');
                    if (!mapInitialized) {
                        initializeMapApp();
                        mapInitialized = true;
                    }
                    setTimeout(() => { if (map) map.invalidateSize(); }, 0);
                } else {
                    landingPage.classList.remove('hidden');
                    if (hash && (landingPageAnchors.includes(hash))) {
                         const targetElement = document.getElementById(hash.substring(1));
                         if (targetElement) {
                             setTimeout(() => targetElement.scrollIntoView({ behavior: 'smooth' }), 0);
                         }
                    } else {
                        window.scrollTo(0, 0);
                    }
                }
                
                setTimeout(handleScrollAnimation, 100);
            }
            
            const speakText = (element) => {
                if (!isTalkbackEnabled || !element || !element.innerText.trim()) {
                    return;
                }

                speechSynthesis.cancel(); 

                const textToRead = element.innerText;
                const utterance = new SpeechSynthesisUtterance(textToRead);
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                const langCode = currentLang === 'ar' ? 'ar-SA' : 'en-US';
                const langShortCode = currentLang === 'ar' ? 'ar' : 'en';

                let selectedVoice = speechVoices.find(voice => voice.lang === langCode);
                if (!selectedVoice) {
                    selectedVoice = speechVoices.find(voice => voice.lang.startsWith(langShortCode));
                }

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                } else {
                    utterance.lang = langCode;
                }
                
                speechSynthesis.speak(utterance);
            };

            const handleMouseOver = (event) => {
                if (!isTalkbackEnabled) return;
                
                const target = event.target.closest('h1, h2, h3, h4, p, a, button, [data-readable]');
                if (target && target !== currentHighlight) {
                     if (currentHighlight) {
                        currentHighlight.classList.remove('talkback-highlight');
                    }
                    currentHighlight = target;
                    currentHighlight.classList.add('talkback-highlight');
                    speakText(target);
                }
            };

            const handleMouseOut = (event) => {
                if (currentHighlight) {
                    currentHighlight.classList.remove('talkback-highlight');
                    currentHighlight = null;
                    speechSynthesis.cancel();
                }
            };

            talkbackToggle.addEventListener('change', () => {
                isTalkbackEnabled = talkbackToggle.checked;
                if(isTalkbackEnabled) {
                    document.body.addEventListener('mouseover', handleMouseOver);
                    document.body.addEventListener('mouseout', handleMouseOut);
                } else {
                    document.body.removeEventListener('mouseover', handleMouseOver);
                    document.body.removeEventListener('mouseout', handleMouseOut);
                    speechSynthesis.cancel();
                     if (currentHighlight) {
                        currentHighlight.classList.remove('talkback-highlight');
                        currentHighlight = null;
                    }
                }
            });


            document.getElementById('launch-map-btn').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = '#map';
            });
            document.getElementById('home-logo-link').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = '';
            });
            
            window.addEventListener('hashchange', () => showPage(window.location.hash));
            showPage(window.location.hash); 


            const closeSidebar = () => document.body.classList.remove('sidebar-open');
            menuBtn.addEventListener('click', () => document.body.classList.add('sidebar-open'));
            closeSidebarBtn.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    const href = link.getAttribute('href');
                    if (!href.startsWith('#') || href === '#') {
                    } else {
                        e.preventDefault();
                        window.location.hash = href;
                    }
                    closeSidebar();
                });
            });

            function initializeMapApp() {
                // API KEYS
                const WAQI_API_KEY = "928a43b09b68edba7abf27fda1fa9a9a754fd8c0";
                const OPENWEATHER_API_KEY = "8e8cc4c4a2a0e8af0a9a96d4d0277b58";
                
                let currentCityData = {}; 

                mapContainer.innerHTML = `
                    <div id="map"></div>
                    <button id="locate-btn" class="absolute bottom-4 left-4 z-[1000] p-3 rounded-full shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" title="Find my location">
                        <svg id="locate-icon" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
                    </button>
                    <div id="data-panel" class="absolute top-[100px] sm:top-24 left-2 right-2 sm:left-auto sm:right-4 sm:w-80 z-[1000] glass-panel p-4 rounded-lg hidden" data-readable="true">
                        <div id="loading" class="flex justify-center items-center h-48"><div class="loader"></div></div>
                        <div id="data-content" class="hidden">
                            <button id="close-panel-btn" class="absolute top-2 right-2 text-gray-400 hover:text-white z-10 p-1 rounded-full hover:bg-gray-700"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button>
                            <h2 id="city-name" class="text-xl font-bold text-white pr-6">...</h2>
                            <p id="update-time" class="text-xs text-gray-400">...</p>
                            <hr class="my-3 border-gray-700">
                            <div class="text-center">
                                <p class="text-sm text-gray-400" data-lang-key="dataPanelAQI">Air Quality Index (AQI)</p>
                                <div id="aqi-value" class="text-6xl font-bold my-2 text-white">--</div>
                                <div id="aqi-status" class="px-3 py-1 text-white rounded-full text-sm inline-block bg-gray-600">...</div>
                            </div>
                            <div id="weather-animation-container" class="relative h-24 my-2 overflow-hidden rounded-lg">
                                <div id="weather-animation"></div>
                            </div>
                            <p id="weather-description" class="text-center text-lg capitalize mb-2 text-white"></p>
                            <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                                <div><p class="text-xs text-gray-400" data-lang-key="dataPanelTemp">Temp</p><p id="temp-value" class="font-bold text-lg text-white">--°C</p></div>
                                <div><p class="text-xs text-gray-400" data-lang-key="dataPanelHumidity">Humidity</p><p id="humidity-value" class="font-bold text-lg text-white">--%</p></div>
                                <div><p class="text-xs text-gray-400" data-lang-key="dataPanelWind">Wind</p><p id="wind-value" class="font-bold text-lg text-white">-- km/h</p></div>
                            </div>
                            <div class="mt-4 bg-gray-900/50 p-2 rounded-lg">
                                <h4 class="font-bold text-sm text-white" data-lang-key="dataPanelHealthAdvice">Health Advice:</h4>
                                <p id="forecast-text" class="text-xs text-gray-300">Analyzing data...</p>
                            </div>
                        </div>
                    </div>
                `;

                const dataPanel = document.getElementById('data-panel');
                const loadingDiv = document.getElementById('loading');
                const dataContentDiv = document.getElementById('data-content');
                const cityNameEl = document.getElementById('city-name');
                const updateTimeEl = document.getElementById('update-time');
                const aqiValueEl = document.getElementById('aqi-value');
                const aqiStatusEl = document.getElementById('aqi-status');
                const weatherAnimationEl = document.getElementById('weather-animation');
                const weatherDescriptionEl = document.getElementById('weather-description');
                const tempValueEl = document.getElementById('temp-value');
                const humidityValueEl = document.getElementById('humidity-value');
                const windValueEl = document.getElementById('wind-value');
                const forecastTextEl = document.getElementById('forecast-text');
                
                map = L.map('map').setView([26.8206, 30.8025], 6); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                let marker = L.marker([26.8206, 30.8025], { opacity: 0 }).addTo(map);

                const currentMapLang = localStorage.getItem('preferredLanguage') || 'en';
                L.Control.geocoder({
                    defaultMarkGeocode: false,
                    placeholder: translations[currentMapLang].searchPlaceholder
                }).on('markgeocode', function(e) {
                    const { center, name } = e.geocode;
                    map.setView(center, 13);
                    marker.setLatLng(center).setOpacity(1);
                    fetchAllDataForLocation(center.lat, center.lng);
                    saveSearchToHistory({ name: name, lat: center.lat, lng: center.lng });
                }).addTo(map);

                const fetchAllDataForLocation = async (lat, lng) => {
                    speechSynthesis.cancel();
                    dataPanel.classList.remove('hidden');
                    loadingDiv.classList.remove('hidden');
                    dataContentDiv.classList.add('hidden');
                    
                    const currentLang = localStorage.getItem('preferredLanguage') || 'en';

                    const results = await Promise.allSettled([
                        fetchAqiData(lat, lng), 
                        fetchWeatherData(lat, lng, currentLang)
                    ]);

                    const aqiResult = results[0];
                    const weatherResult = results[1];

                    const aqiData = aqiResult.status === 'fulfilled' ? aqiResult.value : null;
                    const weatherData = weatherResult.status === 'fulfilled' ? weatherResult.value : null;

                    if (aqiResult.status === 'rejected') console.error("AQI Fetch Error:", aqiResult.reason);
                    if (weatherResult.status === 'rejected') console.error("Weather Fetch Error:", weatherResult.reason);
                    
                    if (!aqiData && !weatherData) {
                        handleError(translations[currentLang].fetchError);
                    } else {
                        updateUIPanel({ aqiData, weatherData, lat, lng });
                    }
                };
                
                const fetchAqiData = async (lat, lng) => {
                    const url = `https://api.waqi.info/feed/geo:${lat};${lng}/?token=${WAQI_API_KEY}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Could not fetch AQI data.');
                    const data = await response.json();
                    if (data.status !== "ok") throw new Error(data.data || 'No station found.');
                    return data.data;
                };

                const fetchWeatherData = async (lat, lng, lang) => {
                    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=${lang}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Could not fetch weather data.');
                    return await response.json();
                };

                const updateWeatherAnimation = (weatherId) => {
                    weatherAnimationEl.innerHTML = ''; // Clear previous animation
                    if (weatherId === 800) { // Clear
                        weatherAnimationEl.innerHTML = '<div class="sun"></div>';
                    } else if (weatherId >= 801 && weatherId <= 804) { // Clouds
                        weatherAnimationEl.innerHTML = '<div class="cloud"></div><div class="cloud c2"></div>';
                    } else if ((weatherId >= 300 && weatherId <= 321) || (weatherId >= 500 && weatherId <= 531)) { // Drizzle & Rain
                        let rainHTML = '<div class="cloud"></div><div class="rain">';
                        for(let i=0; i<20; i++) {
                            const left = Math.random() * 100;
                            const delay = Math.random() * 2;
                            rainHTML += `<div style="left: ${left}%; animation-delay: ${delay}s;"></div>`;
                        }
                        rainHTML += '</div>';
                        weatherAnimationEl.innerHTML = rainHTML;
                    } else if (weatherId >= 200 && weatherId <= 232) { // Thunderstorm
                        let rainHTML = '<div class="cloud" style="background: #888;"></div><div class="thunder"></div><div class="rain">';
                        for(let i=0; i<20; i++) {
                            const left = Math.random() * 100;
                            const delay = Math.random() * 2;
                            rainHTML += `<div style="left: ${left}%; animation-delay: ${delay}s;"></div>`;
                        }
                        rainHTML += '</div>';
                        weatherAnimationEl.innerHTML = rainHTML;
                    } else if (weatherId >= 600 && weatherId <= 622) { // Snow
                        let snowHTML = '<div class="cloud"></div><div class="snow">';
                        for(let i=0; i<20; i++) {
                            const left = Math.random() * 100;
                            const delay = Math.random() * 5;
                             const duration = (Math.random() * 3) + 4; // 4 to 7 seconds
                            snowHTML += `<div style="left: ${left}%; animation-delay: ${delay}s; animation-duration: ${duration}s;"></div>`;
                        }
                        snowHTML += '</div>';
                        weatherAnimationEl.innerHTML = snowHTML;
                    } else if (weatherId >= 701 && weatherId <= 781) { // Mist, Fog, etc.
                        weatherAnimationEl.innerHTML = '<div class="mist"><div class="m1"></div><div class="m2"></div></div>';
                    } else {
                         weatherAnimationEl.innerHTML = '<div class="cloud"></div>'; // Default to cloudy
                    }
                };
                
                const getAqiStatus = (aqi) => {
                     if (aqi <= 50) return { statusKey: "aqiStatusGood", adviceKey: "aqiAdviceGood", color: "#22c55e" };
                     if (aqi <= 100) return { statusKey: "aqiStatusModerate", adviceKey: "aqiAdviceModerate", color: "#facc15" };
                     if (aqi <= 150) return { statusKey: "aqiStatusUnhealthySensitive", adviceKey: "aqiAdviceUnhealthySensitive", color: "#f97316" };
                     if (aqi <= 200) return { statusKey: "aqiStatusUnhealthy", adviceKey: "aqiAdviceUnhealthy", color: "#ef4444" };
                     if (aqi <= 300) return { statusKey: "aqiStatusVeryUnhealthy", adviceKey: "aqiAdviceVeryUnhealthy", color: "#a855f7" };
                     return { statusKey: "aqiStatusHazardous", adviceKey: "aqiAdviceHazardous", color: "#7f1d1d" };
                };

                const updateUIPanel = ({ aqiData, weatherData, lat, lng }) => {
                    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                    
                    currentLocationData = { aqiData, weatherData };
                    getForecastBtn.classList.remove('hidden');

                    cityNameEl.textContent = weatherData?.name || aqiData?.city?.name || 'Unknown Location';

                    if (aqiData && aqiData.time) {
                        const locale = currentLang === 'ar' ? 'ar-EG' : 'en-US';
                        const localizedDate = new Date(aqiData.time.s * 1000).toLocaleString(locale, {
                            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                        });
                        updateTimeEl.textContent = `${translations[currentLang].updatedLabel}: ${localizedDate}`;
                        
                        aqiValueEl.textContent = aqiData.aqi;
                        const { statusKey, adviceKey, color } = getAqiStatus(aqiData.aqi);
                        aqiStatusEl.textContent = translations[currentLang][statusKey];
                        aqiStatusEl.style.backgroundColor = color;
                        forecastTextEl.textContent = translations[currentLang][adviceKey];
                    } else {
                        handleError(translations[currentLang].aqiError);
                    }

                    if (weatherData && weatherData.weather) {
                        updateWeatherAnimation(weatherData.weather[0].id);
                        weatherDescriptionEl.textContent = weatherData.weather[0].description;
                    }

                    if (weatherData && weatherData.main) {
                        tempValueEl.textContent = `${Math.round(weatherData.main.temp)}°C`;
                        humidityValueEl.textContent = `${weatherData.main.humidity}%`;
                        windValueEl.textContent = `${Math.round(weatherData.wind.speed * 3.6)} km/h`;
                    }
                    loadingDiv.classList.add('hidden');
                    dataContentDiv.classList.remove('hidden');
                };
                
                const handleError = (message) => {
                    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                    cityNameEl.textContent = translations[currentLang].errorTitle;
                    updateTimeEl.textContent = "";
                    aqiValueEl.textContent = "N/A";
                    aqiStatusEl.textContent = translations[currentLang].aqiStatusNoData;
                    aqiStatusEl.style.backgroundColor = "#9ca3af";
                    forecastTextEl.textContent = message;
                    weatherDescriptionEl.textContent = "";
                    weatherAnimationEl.innerHTML = "";
                    loadingDiv.classList.add('hidden');
                    dataContentDiv.classList.remove('hidden');
                };

                map.on('click', function(e) {
                    const { lat, lng } = e.latlng;
                    marker.setLatLng(e.latlng).setOpacity(1);
                    fetchAllDataForLocation(lat, lng);
                    const geocoder = L.Control.Geocoder.nominatim();
                    geocoder.reverse(e.latlng, map.options.crs.scale(map.getZoom()), (results) => {
                        if (results && results.length > 0 && results[0].name) {
                            saveSearchToHistory({ name: results[0].name, lat: lat, lng: lng });
                        }
                    });
                });
                
                document.getElementById('close-panel-btn').addEventListener('click', () => {
                    speechSynthesis.cancel();
                    dataPanel.classList.add('hidden');
                });
                document.getElementById('locate-btn').addEventListener('click', () => map.locate({setView: true, maxZoom: 13}));
                map.on('locationfound', (e) => {
                    marker.setLatLng(e.latlng).setOpacity(1);
                    fetchAllDataForLocation(e.latlng.lat, e.latlng.lng);
                });
                map.on('locationerror', (e) => console.error("Location Error: ", e.message));
            }
        });
    </script>
</body>
</html>
