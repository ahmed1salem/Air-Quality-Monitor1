<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Content Security Policy (CSP) for enhanced security -->
    <meta http-equiv="Content-Security-Policy"  
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://unpkg.com;
                   style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://unpkg.com https://fonts.googleapis.com; 
                   font-src 'self' https://fonts.gstatic.com; 
                   img-src 'self' https: data: blob: https://raw.githubusercontent.com https://placehold.co https://i.ibb.co https://images.unsplash.com;
                   connect-src 'self' https://api.waqi.info https://api.openweathermap.org https://api.openaq.org https://gibs.earthdata.nasa.gov https://generativelanguage.googleapis.com;">

    <title>Air Quality Monitor - Live AQI & Pollution Map by Digital Minds</title>
    <meta name="description" content="Track real-time air quality and weather levels anywhere in the world. Get live AQI data, weather updates, and health recommendations with our interactive map, developed by the Digital Minds team.">
    <meta name="keywords" content="air quality, aqi, pollution, live map, air quality index, weather, real-time data, digital minds, web developer, portfolio">
    <meta name="author" content="Digital Minds">
    <link rel="canonical" href="https://air-quality-monitor-3.netlify.app" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjk7K0IOVXn7WvuM8wl4rXWpCAvvMG8mUjenuSlZsBh6iUeoH8SlHd-dzzCdnIoSxHr6atY7R8fQKji1gIeZ282QhKL-QbXSEUaayoYuxFdtWtogbLhcBOwBAKWuKcolUYEzDxDd8xkgjP-ZSIsIS1DsSx_50DhHDoUp8LVN1hDsy-jHCJxn4vbPnoKnYE/s1260/favicon.png">
    
    <!-- Tailwind CSS, Google Fonts, LeafletJS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&family=Cairo:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        /* --- Base Styles (Dark Mode by Default) --- */
        :root { 
            --font-primary: 'Exo 2', sans-serif; 
            --font-secondary: 'Cairo', sans-serif;
            --color-bg: #0a0f1f;
            --color-bg-panel: rgba(17, 24, 39, 0.8);
            --color-text: #e5e7eb;
            --color-text-muted: #9ca3af;
            --color-accent: #4f46e5;
            --color-accent-glow: rgba(79, 70, 229, 0.5);
            --border-color: rgba(79, 70, 229, 0.2);
        }
        html { scroll-behavior: smooth; }
        body { 
            background-color: var(--color-bg); 
            color: var(--color-text); 
            scroll-behavior: smooth; 
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        .lang-en { font-family: var(--font-primary); }
        .lang-ar { font-family: var(--font-secondary); }

        /* --- Map Styles --- */
        #map-container { height: 100vh; width: 100vw; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .leaflet-tile-pane { 
            filter: invert(1) hue-rotate(180deg) brightness(0.8) contrast(1.1); 
        }
        .leaflet-control-geocoder a, .leaflet-control-zoom a, #locate-btn { 
            background-color: var(--color-bg-panel) !important;
            color: var(--color-text) !important; 
            border: 1px solid var(--border-color) !important;
            backdrop-filter: blur(10px);
        }
        .leaflet-control-geocoder, .leaflet-control-zoom { border: none !important; }
        .leaflet-control-geocoder-form input { 
            background-color: rgba(30, 41, 59, 0.9) !important;
            color: var(--color-text) !important; 
            border: 1px solid var(--border-color) !important;
        }

        /* --- Space Theme Backgrounds --- */
        .hero-bg {
            background-color: #000;
            position: relative;
            overflow: hidden;
        }
        #stars1, #stars2, #stars3 {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            display: block;
            background: transparent;
        }
        #stars1 {
            background-image: radial-gradient(1px 1px at 20px 30px, #eee, transparent), radial-gradient(1px 1px at 40px 70px, #fff, transparent), radial-gradient(1px 1px at 50px 160px, #ddd, transparent), radial-gradient(1px 1px at 90px 40px, #fff, transparent), radial-gradient(1px 1px at 130px 80px, #fff, transparent), radial-gradient(1px 1px at 160px 120px, #ddd, transparent);
            background-size: 200px 200px;
            animation: zoom 15s alternate infinite;
        }
        #stars2 {
            background-image: radial-gradient(1px 1px at 20px 30px, #eee, transparent), radial-gradient(1px 1px at 40px 70px, #fff, transparent), radial-gradient(1px 1px at 50px 160px, #ddd, transparent), radial-gradient(1px 1px at 90px 40px, #fff, transparent), radial-gradient(1px 1px at 130px 80px, #fff, transparent), radial-gradient(1px 1px at 160px 120px, #ddd, transparent);
            background-size: 300px 300px;
            background-position: 100px 100px;
            animation: zoom 25s alternate infinite;
        }
        #stars3 {
            background-image: radial-gradient(1.5px 1.5px at 20px 30px, #eee, transparent), radial-gradient(1.5px 1.5px at 40px 70px, #fff, transparent), radial-gradient(2px 2px at 50px 160px, #ddd, transparent), radial-gradient(1px 1px at 90px 40px, #fff, transparent), radial-gradient(1.5px 1.5px at 130px 80px, #fff, transparent), radial-gradient(2px 2px at 160px 120px, #ddd, transparent);
            background-size: 500px 500px;
            background-position: 200px 200px;
            animation: zoom 40s alternate infinite;
        }
        @keyframes zoom {
            0% { transform: scale(1); }
            100% { transform: scale(1.2); }
        }

        #shooting-stars-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        .shooting-star {
            position: absolute;
            left: -150px;
            width: 150px;
            height: 2px;
            background: linear-gradient(to right, #fff, transparent);
            animation-name: shoot;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }
        @keyframes shoot {
            from { transform: translateX(0); }
            to { transform: translateX(calc(100vw + 300px)); }
        }

        /* From Uiverse.io by Lakshay-art */
        .section-banner {
            height: 250px;
            width: 250px;
            position: relative;
            transition: left 0.3s linear;
            background: url("data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/2wBDACYaHSEdGCYhHyErKCYtOV8+OTQ0OXVTWEVfinmRj4h5hYOYq9u6mKLPpIOFvv/Bz+Lp9fj1lLf////u/9vw9ez/2wBDASgrKzkyOXA+PnDsnYWd7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Oz/wAARCAE5AfQDASIAAhEBAxEB/8QAGgAAAwEBAQEAAAAAAAAAAAAAAgMEAQAFBv/EADoQAAIBAwIFAwIFAgUFAQADAAECEQADIRIxBCJBUWETcYEykRRCUqGxI8EFYnLR8DOCkuHxQxVTY//EABgBAQEBAQEAAAAAAAAAAAAAAAABAgME/8QAIBEBAQEAAwEBAAMBAQAAAAAAAAERAiExEkETUXEDYf/aAAwDAQACEQMRAD8A9T1Adg32rZPtWavI+9bA8VpAy3dftRDP5vtSmuDaPtXBWI5dSjyaYhx0jd/3riyD89TlXH029fzWAOufTtp96Yaf61rb1Kw3rQ/P+1KD92n2U0epTnQ3wKuAhxFo7GfisPE2huY94rAQThG9sAULBQPox4IpkDBftMJUz8Vmv/QPegV7cxoB/eiKof8A8ZpgFr4XdlHwaAcWn6x8LTQkbWVH2rpYHCn7U6AjiVPU/wDjW+uP1D5FFqJEQD70GknMADsBFAYuk7H7LXa26k/+NcGYefijWf8AgqANTxgH/wAazXc/Sf8AwpuOprGmOWKKSbrgTA/8TWes/wClaZqHWJ8Zro1dvmqhfrxuq/eu9YxISfY1rLp3VfkCsVo2Fv8AiqM9c/8A9bV3rx/+T/aiJU/UFHkNShYXJV1z3n/enSGi8D+UzRqxP5alNoz/ANa17ATWCyx+niAPmmQV6u4rdY61J6fELtdDfNDr4lTzIGHjemGrda9x962QdiKlW8mrmLp4KmqF0ESp/aKij0jxW6B0iksLUwXAPvXemoEy0eDQO0e1ZpHilBViSG+WrtNsn64PioGEe1cQImaDQnVprilsDOP+6qO1Cd5rp7A/ehLWx9Pp/LUOt5hTY+9A2T2H3rA+Y5fvS9dwQSLQ8zXfiAMMLRH+qiGF4MHT967VPQfcVO13hyZ9FSfDVnqWelhfk1cDjdUd/g0QugiQ0fNJFwDK2bcdxXeuZghR4j/1QMN8D89aL6H84oBfH6Y/7aI3kjNsfagaHU9Qfmt1Cdh96Ut2ye3/AI0X9IjlVDUUZYfoP3rNX/8Am3waGF/T+9CSqnKAe5oDNwdVYe9YbqdA1Z6w2BU0J4gLgqtMB+snUH70QvWz3+9Bbu+ocLjvpxWu4Xe1PkUB+qld6qePvSg9o/lK0RNro0e1MDPUH+X71nqp1FK1WRktq+KIC0/0zUyBnqp0/it9W33H2oBbQ400JtocTHtTIG60/UK6khE6XG+9dTBIeKukSBB7QKKzxF0nnIj2rbic35vcCsXUJ2MdDW+kVAh1lTFMXaovWB6Ed4NN9UEjH71nFVD3rPSU5k/egt3J/KBFZdukJIYKo3JzUxR+mi5E/c1zagOWKSpvMNXqrpO2JrR62row77UGM7A5kewqch9wQx7RVbFozbn2M1i20YfTHvVlTE/rNbXntftWWuKRjpKaT3BptxdLAKRnoKWbNtxGgT3HStdIpV8YIIrifJFQCwVIKOwHWMU4LciRcvDsGG9TIacbkGAwohdM5AIpDawCXtK4HWCDXWmRtgV8MaYKCysOvxQZGzVhxRCQNqhodRHU12onua6u22qprQW2j96wgjOPvXAEVsGJCE+1F1mqGkAVpdWHMs/NCCMyo+ZrdYGNGr5NBk2JyF+4oh6PRT8Ut3Trailm1auNKgr/AKRQURaO6P8A+NZpsloCtPaK62giAHI7kYpn07H9qi4XptHKhj8U1Vjv80vUQ+ogrPmuLmcKfcGgYdUYJqN7xW7pchx/mUVR6hIgjHkVLxNkMZClT52pIU1b1m6IkKR0Bx+9M3H9Ncd1ivPWxJyG+BNV8Pw628uAD071bJENlQOYE+9CSp+m18laZqVR9LHzFGus7KAP8xqauEAtP/TSPIrtJnCLnuKpz4/iu001cTi23VU+1ELafpXzijM94odQiAfim1HC2o2An/SKE236KnvprIA5rhI6RWszRI5E+5P+1Bg4ePqcjwKNURTAT5oFa3Opyy/5ZrvUDNB5VO0GnZ0J7kYEg9KwW8e9G7D2P3pYu3E/Mo98VlR76O4J2BpguOoyQPM0j8TYk5J9tq57iOMxQO/E3E+kAe9C3GXFwWj2paMSZOKMEqZI+xosP/yF/k71h45h9VqY3z/W2bM7dKUy6z/AEz81WlEcdcuEAWwCe9Tf4nc29Uj2qk2XAzXCy+Iq2mX8Vcvn05P+qmPx1zVpCAz5qM20UfUvtWgW1MldPtUWUpxV5s6QPiui/fuHKiPG1E0YGKwECigQ98fTXgEjpXZ8itk/WvtRFA2n+9coB3msA/eqH3q+mP//Z");
            background-size: cover;
            background-position: left;
            bottom: 0px;
            border-radius: 50%;
            animation: earthRotate 30s linear 0s infinite;
            box-shadow: 0px 0 20px RGBA(255, 255, 255, 0.2), -5px 0px 8px #c3f4ff inset,
            15px 2px 25px #000 inset, -24px -2px 34px #c3f4ff99 inset,
            250px 0px 44px #00000066 inset, 150px 0px 38px #000000aa inset;
        }
        @keyframes earthRotate {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 400px 0;
            }
        }

        .curved-corner-star {
            display: flex;
            position: relative;
        }

        #curved-corner-bottomleft,
        #curved-corner-bottomright,
        #curved-corner-topleft,
        #curved-corner-topright {
            width: 4px;
            height: 5px;
            overflow: hidden;
            position: relative;
        }

        #curved-corner-bottomleft:before,
        #curved-corner-bottomright:before,
        #curved-corner-topleft:before,
        #curved-corner-topright:before {
            content: "";
            display: block;
            width: 200%;
            height: 200%;
            position: absolute;
            border-radius: 50%;
        }

        #curved-corner-bottomleft:before {
            bottom: 0;
            left: 0;
            box-shadow: -5px 5px 0 0 white;
        }

        #curved-corner-bottomright:before {
            bottom: 0;
            right: 0;
            box-shadow: 5px 5px 0 0 white;
        }

        #curved-corner-topleft:before {
            top: 0;
            left: 0;
            box-shadow: -5px -5px 0 0 white;
        }

        #curved-corner-topright:before {
            top: 0;
            right: 0;
            box-shadow: 5px -5px 0 0 white;
        }

        @keyframes twinkling {
            0%,
            100% {
                opacity: 0.1;
            }
            50% {
                opacity: 1;
            }
        }

        #star-1 {
            position: absolute;
            left: -20px;
            animation: twinkling 3s infinite;
        }

        #star-2 {
            position: absolute;
            left: -40px;
            top: 30px;
            animation: twinkling 2s infinite;
        }
        #star-3 {
            position: absolute;
            left: 350px;
            top: 90px;
            animation: twinkling 4s infinite;
        }
        #star-4 {
            position: absolute;
            left: 200px;
            top: 290px;
            animation: twinkling 3s infinite;
        }
        #star-5 {
            position: absolute;
            left: 50px;
            top: 270px;
            animation: twinkling 1.5s infinite;
        }

        #star-6 {
            position: absolute;
            left: 250px;
            top: -50px;
            animation: twinkling 4s infinite;
        }
        #star-7 {
            position: absolute;
            left: 290px;
            top: 60px;
            animation: twinkling 2s infinite;
        }
        /* --- End of Uiverse.io snippet --- */

        /* --- Components & UI Elements --- */
        .glass-panel {
            background-color: var(--color-bg-panel);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .glow-button {
            background-color: var(--color-accent);
            box-shadow: 0 0 15px var(--color-accent-glow), 0 0 25px var(--color-accent-glow);
            transition: all 0.3s ease;
        }
        .glow-button:hover {
            box-shadow: 0 0 25px var(--color-accent-glow), 0 0 40px var(--color-accent-glow);
            transform: scale(1.05);
        }
        .modal-input {
            background-color: rgba(10, 15, 31, 0.7);
            border: 1px solid var(--border-color);
            color: var(--color-text);
        }
        .modal-input:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 10px var(--color-accent-glow);
            outline: none;
        }
        
        /* --- Loader --- */
        .loader { 
            border: 5px solid rgba(79, 70, 229, 0.2); 
            border-top: 5px solid var(--color-accent); 
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Sidebar Styles --- */
        #sidebar { transition: transform 0.3s ease-in-out; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .sidebar-open #sidebar { transform: translateX(0); }
        .sidebar-open #sidebar-overlay { opacity: 1; pointer-events: auto; }

        html[dir="rtl"] #sidebar { left: auto; right: 0; transform: translateX(100%); }
        html[dir="rtl"] .sidebar-open #sidebar { transform: translateX(0); }
        html[dir="rtl"] #close-sidebar-btn { right: auto; left: 1rem; }

        .leaflet-control-container .leaflet-top { top: 80px; }
        @media (max-width: 640px) { .leaflet-control-container .leaflet-top { top: 90px; } }
        
        /* --- Weather Animation Styles --- */
        #weather-animation-container { background: linear-gradient(to bottom, #0c1445, #2d3748); }
        #weather-animation { position: relative; width: 100%; height: 100%; }
        .sun, .cloud, .rain, .snow, .mist, .thunder { position: absolute; }
        .sun { top: 15%; left: 50%; width: 40px; height: 40px; background: #FFD700; border-radius: 50%; transform: translateX(-50%); box-shadow: 0 0 20px #FFD700; }
        .cloud { background: #fff; border-radius: 50%; width: 60px; height: 60px; top: 30%; left: -80px; animation: move-cloud 15s linear infinite; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .cloud::before, .cloud::after { content: ''; position: absolute; background: #fff; border-radius: 50%; }
        .cloud::before { width: 40px; height: 40px; top: -20px; right: 10px; }
        .cloud::after { width: 50px; height: 50px; top: -10px; left: 5px; }
        .cloud.c2 { animation-delay: -5s; top: 45%; transform: scale(0.8); }
        @keyframes move-cloud { 0% { left: -80px; } 100% { left: 110%; } }
        .rain > div { position: absolute; width: 2px; height: 10px; background: #77aadd; animation: fall 1s linear infinite; }
        @keyframes fall { 0% { transform: translateY(-20px); } 100% { transform: translateY(120px); } }
        .snow > div { position: absolute; width: 5px; height: 5px; background: #fff; border-radius: 50%; animation: snowfall 5s linear infinite; }
        @keyframes snowfall { 0% { transform: translateY(-20px) translateX(0); } 100% { transform: translateY(120px) translateX(20px); } }
        .mist > div { position: absolute; width: 120%; height: 30px; background: rgba(255,255,255,0.2); border-radius: 15px; bottom: 0; left: -10%; animation: move-mist 10s linear infinite alternate; }
        .mist > div.m2 { animation-delay: -5s; opacity: 0.5; }
        @keyframes move-mist { from { transform: translateX(-20px); } to { transform: translateX(20px); } }
        .thunder { width: 100%; height: 100%; background: rgba(255, 255, 0, 0.3); opacity: 0; animation: lightning 3s linear infinite; }
        @keyframes lightning { 0%, 100% { opacity: 0; } 50% { opacity: 1; } 52% { opacity: 0; } 55% { opacity: 1; } 56% { opacity: 0; } }

        .talkback-highlight { background-color: rgba(79, 70, 229, 0.4); }

        /* --- Scroll Animations --- */
        .animate-on-scroll { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .animate-on-scroll.is-visible { opacity: 1; transform: translateY(0); }
        .team-card { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .team-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 0 15px var(--color-accent-glow), 0 0 25px var(--color-accent-glow);
        }
        .aqi-level-card {
            border-left-width: 4px;
        }

        /* --- Light Mode Overrides --- */
        html.light body {
            --color-bg: #f8fafc;
            --color-bg-panel: rgba(255, 255, 255, 0.8);
            --color-text: #1f2937;
            --color-text-muted: #6b7280;
            --border-color: rgba(209, 213, 219, 0.7);
            background-color: var(--color-bg);
            color: var(--color-text);
        }
        html.light .text-gray-200 { color: var(--color-text); }
        html.light .glass-panel {
            background-color: var(--color-bg-panel);
            border: 1px solid var(--border-color);
            color: var(--color-text);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        html.light .text-white { color: #111827 !important; }
        html.light .text-gray-300 { color: #4b5563; }
        html.light .text-gray-400 { color: #6b7280; }
        html.light .border-gray-700 { border-color: #e5e7eb; }
        html.light .border-gray-800 { border-color: #d1d5db; }
        html.light .modal-input {
            background-color: #f9fafb;
            border-color: #d1d5db;
            color: #111827;
        }
        html.light .modal-input:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 5px var(--color-accent-glow);
        }
        html.light .hero-bg {
            background-color: #e0e7ff;
            background-image: none;
        }
        html.light #stars1, html.light #stars2, html.light #stars3, html.light #shooting-stars-container, html.light .section-banner {
            display: none;
        }
        html.light .leaflet-tile-pane { filter: none; }
        html.light .leaflet-control-geocoder a, html.light .leaflet-control-zoom a, html.light #locate-btn {
            background-color: #fff !important;
            color: #1f2937 !important;
            border: 1px solid #d1d5db !important;
        }
        html.light .leaflet-control-geocoder-form input {
            background-color: #fff !important;
            color: #111827 !important;
            border: 1px solid #d1d5db !important;
        }
        html.light header, html.light footer {
            background-color: rgba(255, 255, 255, 0.7);
        }
        html.light .hover\:text-indigo-400:hover { color: #4f46e5; }
        html.light .team-card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        html.light .team-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        html.light #weather-animation-container {
            background: linear-gradient(to bottom, #87CEEB, #B0E0E6);
        }
        html.light #sidebar { color: var(--color-text); }
        html.light .bg-transparent { background-color: #f8fafc; }
        html.light .text-red-400 { color: #ef4444; }
        html.light .text-green-400 { color: #22c55e; }
        html.light .text-indigo-400 { color: #6366f1; }
        html.light .text-indigo-300 { color: #818cf8; }
    </style>
</head>
<body class="text-gray-200">

    
    <!-- Sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none"></div>
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 glass-panel z-40 transform -translate-x-full p-6">
        <button id="close-sidebar-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
        <div class="mt-8 space-y-4">
            <!-- Navigation Links -->
            <a href="#" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navHome">Home</a>
            <a href="#mission" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navMission">Our Mission</a>
            <a href="#aqi-guide" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navAqiGuide">AQI Guide</a>
            <a href="#map" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navMap">Map</a>
            <a href="#team" class="sidebar-link block py-2 text-gray-300 hover:text-indigo-400" data-lang-key="navTeam">Our Team</a>
            <hr class="border-gray-700">
            <!-- Settings -->
            <div class="space-y-4">
                <h3 class="font-bold text-lg text-white" data-lang-key="navSettings">Settings</h3>
                <div class="flex items-center justify-between">
                    <span class="text-gray-300" data-lang-key="navLanguage">Language</span>
                    <div class="flex space-x-1">
                        <button id="lang-en-sidebar" class="font-semibold text-sm py-1 px-2 rounded">EN</button>
                        <button id="lang-ar-sidebar" class="font-semibold text-sm py-1 px-2 rounded">AR</button>
                    </div>
                </div>
                 <div class="flex items-center justify-between">
                    <span class="text-gray-300" data-lang-key="navTheme">Theme</span>
                    <button id="theme-toggle-sidebar" class="p-2 rounded-lg text-gray-400 hover:bg-gray-700"></button>
                </div>
                <div class="flex items-center justify-between">
                    <label for="talkback-toggle" class="text-gray-300" data-lang-key="navTalkback">Read on Hover</label>
                    <input type="checkbox" id="talkback-toggle" class="form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                </div>
            </div>
        </div>
    </div>


    <!-- Main Content -->
    <div id="main-content">
        <header class="bg-black/30 backdrop-blur-sm fixed top-0 left-0 right-0 z-20">
            <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                <button id="menu-btn" class="text-white p-2 rounded-lg hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <a href="#" id="home-logo-link" class="flex items-center space-x-2">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjk7K0IOVXn7WvuM8wl4rXWpCAvvMG8mUjenuSlZsBh6iUeoH8SlHd-dzzCdnIoSxHr6atY7R8fQKji1gIeZ282QhKL-QbXSEUaayoYuxFdtWtogbLhcBOwBAKWuKcolUYEzDxDd8xkgjP-ZSIsIS1DsSx_50DhHDoUp8LVN1hDsy-jHCJxn4vbPnoKnYE/s1260/favicon.png" alt="Logo" class="h-8 w-8">
                    <h1 class="text-lg sm:text-xl font-bold text-white" data-lang-key="appName">Air Quality Monitor</h1>
                </a>
            </nav>
        </header>

        <!-- Landing Page View -->
        <div id="landing-page">
            <section class="hero-bg text-white pt-48 sm:pt-32 pb-20 text-center">
                <div id="stars1"></div>
                <div id="stars2"></div>
                <div id="stars3"></div>
                <div id="shooting-stars-container"></div>
                <div class="absolute inset-0 flex items-center justify-center opacity-40 z-0 pointer-events-none">
                    <div class="section-banner">
                        <div id="star-1">
                            <div class="curved-corner-star">
                                <div id="curved-corner-bottomright"></div>
                                <div id="curved-corner-bottomleft"></div>
                            </div>
                            <div class="curved-corner-star">
                                <div id="curved-corner-topright"></div>
                                <div id="curved-corner-topleft"></div>
                            </div>
                        </div>
                        <div id="star-2"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-3"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-4"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-5"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-6"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                        <div id="star-7"><div class="curved-corner-star"><div id="curved-corner-bottomright"></div><div id="curved-corner-bottomleft"></div></div><div class="curved-corner-star"><div id="curved-corner-topright"></div><div id="curved-corner-topleft"></div></div></div>
                    </div>
                </div>
                <div class="container mx-auto px-4 relative z-10 animate-on-scroll">
                    <h2 class="text-3xl sm:text-4xl md:text-6xl font-black mb-4 leading-tight uppercase" data-lang-key="heroTitle">Breathe Clearer. Live Better.</h2>
                    <p class="text-base sm:text-lg md:text-xl text-gray-300 mb-8 max-w-3xl mx-auto" data-lang-key="heroSubtitle">Your real-time guide to the air you breathe. We provide live, accurate air quality data to help you make healthier decisions every day.</p>
                    <a href="#map" id="launch-map-btn" class="glow-button text-white text-lg px-8 py-4 rounded-lg font-bold inline-block" data-lang-key="heroButton">Launch Live Map</a>
                </div>
            </section>
            
            <section id="about-features" class="py-20 bg-transparent">
                <div class="container mx-auto px-4">
                    <div class="text-center mb-16 animate-on-scroll">
                        <h2 class="text-3xl md:text-4xl font-bold text-white" data-lang-key="aboutTitle">A Comprehensive Tool for Your Well-being</h2>
                        <p class="text-gray-400 mt-4 max-w-3xl mx-auto" data-lang-key="aboutSubtitle">We combine air quality, weather data, and personalized features to give you a complete picture of your environment.</p>
                    </div>
            
                    <div class="space-y-16">
                        <div class="flex flex-wrap items-center animate-on-scroll">
                            <div class="w-full md:w-1/2 lg:w-5/12 px-4 md:pr-8">
                                <div class="p-3 text-indigo-400 bg-indigo-900/50 rounded-full inline-block mb-4">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                <h3 class="text-2xl font-bold mb-3 text-white" data-lang-key="feature1Title">Live Interactive Map</h3>
                                <p class="text-gray-400" data-lang-key="feature1Desc">Our core feature is a dynamic world map. Click anywhere to get instant, real-time Air Quality Index (AQI) data from the nearest monitoring station. Track pollution levels in your city or anywhere you plan to travel.</p>
                            </div>
                            <div class="w-full md:w-1/2 lg:w-7/12 mt-8 md:mt-0">
                                <img src="https://images.unsplash.com/photo-1614728263952-84ea256ec346?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80" alt="Planet from space" class="rounded-lg shadow-2xl shadow-indigo-900/50">
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center flex-col-reverse md:flex-row-reverse animate-on-scroll">
                            <div class="w-full md:w-1/2 lg:w-5/12 px-4 md:pl-8 mt-8 md:mt-0">
                                <div class="p-3 text-green-400 bg-green-900/50 rounded-full inline-block mb-4">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <h3 class="text-2xl font-bold mb-3 text-white" data-lang-key="feature2Title">Detailed Data & Weather</h3>
                                <p class="text-gray-400" data-lang-key="feature2Desc">Beyond the AQI number, our detailed panel shows you crucial weather information like temperature, humidity, and wind speed. This helps you understand how weather conditions affect air quality.</p>
                            </div>
                            <div class="w-full md:w-1/2 lg:w-7/12">
                                <img src="https://images.unsplash.com/photo-1518770660439-4636190af475?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80" alt="Futuristic data dashboard" class="rounded-lg shadow-2xl shadow-indigo-900/50">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

             <!-- Mission Section -->
            <section id="mission" class="py-20 bg-transparent">
                <div class="container mx-auto px-4">
                    <div class="glass-panel rounded-lg p-8 md:p-12 animate-on-scroll">
                        <div class="text-center">
                            <h2 class="text-3xl md:text-4xl font-bold text-white mb-2" data-lang-key="missionTitle">Our Mission: Earth's Health from a Celestial View</h2>
                            <p class="text-lg text-indigo-300 mb-2" data-lang-key="missionSubtitle">A NASA Space Apps Challenge 2025 Project</p>
                            <p class="text-gray-400 italic mt-2 mb-6 max-w-3xl mx-auto" data-lang-key="missionChallengeName"></p>
                            <p class="text-gray-300 max-w-4xl mx-auto mb-4" data-lang-key="missionDesc">This project was born out of the NASA Space Apps Challenge Cairo 2025, marking the 11th local edition of this global event. Our goal is to leverage the power of data, inspired by space exploration, to bring crucial environmental information to your fingertips. By monitoring air quality, we aim to foster a healthier relationship between humanity and our home planet.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AQI Guide Section -->
            <section id="aqi-guide" class="py-20 bg-transparent">
                <div class="container mx-auto px-4">
                    <div class="text-center mb-16 animate-on-scroll">
                        <h2 class="text-3xl md:text-4xl font-bold text-white" data-lang-key="aqiGuideTitle">Understanding the Air Quality Index (AQI)</h2>
                        <p class="text-gray-400 mt-4 max-w-3xl mx-auto" data-lang-key="aqiGuideDesc">The AQI is your guide to understanding how clean or polluted the air is. Here's a quick breakdown of the levels:</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
                        <!-- AQI Levels will be injected here by JS -->
                    </div>
                </div>
            </section>

            <!-- Team Section -->
            <section id="team" class="py-20 bg-transparent">
                 <div class="container mx-auto px-4">
                    <div class="text-center mb-16 animate-on-scroll">
                        <h2 class="text-3xl md:text-4xl font-bold text-white" data-lang-key="teamTitle">Meet Our Team</h2>
                        <p class="text-lg text-gray-400 mt-2 italic" data-lang-key="teamSlogan">Together, we build solutions for a better tomorrow.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl mx-auto">
                        <!-- Team Member Cards will be injected here -->
                    </div>
                </div>
            </section>

        </div>
        
        <!-- Page Content Views (Initially empty container for other pages if needed) -->
        <div id="page-content" class="hidden pt-20">
        </div>

        <!-- Map & App Section (Initially Hidden) -->
        <div id="map-view" class="hidden">
             <div id="map-container" class="relative">
                <div id="map"></div>
                <!-- Data Panel and other map overlays will be added here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-black/30 py-6 text-center text-gray-400 border-t border-gray-800">
        <div class="container mx-auto px-4">
            <p data-lang-key="footerText">&copy; 2024 All rights reserved for Digital Minds team</p>
        </div>
    </footer>

    <!-- AI Assistant Button and Modal -->
    <button id="ai-assistant-btn" class="fixed bottom-6 right-6 z-[1500] w-16 h-16 rounded-full glow-button flex items-center justify-center shadow-lg">
        <svg class="w-8 h-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12 12m-6 0a6 6 0 1 0 12 0a6 6 0 1 0 -12 0" fill="#4f46e5" fill-opacity="0.3" /><path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c.34 0 .67-.03 1-.09-.36-.6-.58-1.29-.58-2.04 0-2.21 1.79-4 4-4 .75 0 1.44.22 2.04.58-.06-.33-.09-.66-.09-1 0-3.31-2.69-6-6-6zm-1.5 6.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm3 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
    </button>

    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[2000] flex justify-center items-center hidden">
        <div class="glass-panel p-6 rounded-lg w-full max-w-lg h-[80vh] flex flex-col mx-4 relative">
            <button id="close-ai-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-center text-white" data-lang-key="aiAssistantTitle">AI Assistant</h3>
            <div id="ai-chat-window" class="flex-grow bg-gray-900/50 rounded-lg p-4 overflow-y-auto mb-4">
                <!-- Chat messages will be injected here -->
            </div>
            <div id="ai-loading-indicator" class="hidden text-center mb-2">
                <p class="text-sm text-gray-400" data-lang-key="aiTyping">AI is typing...</p>
            </div>
            <div id="ai-context-actions" class="flex justify-center space-x-2 mb-2">
                <button id="get-forecast-btn" class="text-sm bg-indigo-800 hover:bg-indigo-700 text-white py-1 px-3 rounded-full hidden" data-lang-key="getForecast">Get Forecast</button>
                <button id="health-profile-btn" class="text-sm bg-green-800 hover:bg-green-700 text-white py-1 px-3 rounded-full" data-lang-key="myHealth">My Health</button>
            </div>
            <div id="health-profile-section" class="hidden p-2 bg-gray-800/50 rounded-lg mb-2">
                <p class="text-sm text-center text-gray-300 mb-2" data-lang-key="healthProfilePrompt">Select any conditions for personalized advice:</p>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="Asthma" class="health-condition form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                        <span data-lang-key="healthAsthma">Asthma</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="Allergies" class="health-condition form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                        <span data-lang-key="healthAllergies">Allergies</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="Heart Condition" class="health-condition form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                        <span data-lang-key="healthHeart">Heart Condition</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" value="Lung Condition" class="health-condition form-checkbox h-4 w-4 text-indigo-500 bg-gray-700 border-gray-600 rounded">
                        <span data-lang-key="healthLungs">Lung Condition</span>
                    </label>
                </div>
            </div>
            <form id="ai-input-form" class="flex items-center">
                <input id="ai-user-input" type="text" class="w-full p-3 rounded-lg modal-input" required placeholder="Ask about weather, AQI, or health advice..." data-lang-key="aiPlaceholder">
                <button type="submit" class="ml-3 p-3 rounded-lg glow-button">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2.925 3.555l14.15 6.445a.5.5 0 010 .9l-14.15 6.445a.5.5 0 01-.825-.45V3.905a.5.5 0 01.825-.35z"></path></svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Script -->
    <script type="module">
        // --- Gemini API Key ---
        const GEMINI_API_KEY = "AIzaSyDgd0sCe4CXWO6e7rqJufMwdbcTCFHNsco";

        // --- TEAM DATA ---
        const teamMembers = [
            { name: "Ahmed Salem Khalifa", role: "Team Lead & LLM Specialist", desc: "Responsible for the overall project vision, managing the development timeline, and coordinating the team's tasks. His expertise as an LLM Specialist will guide any future integrations of AI-powered features.", img: "https://i.ibb.co/RGtFVr0/IMG-20241204-WA0010-Copy.jpg" },
            { name: "Roqaya Mohamed Ahmed", role: "Business Strategist & Frontend Developer", desc: "Responsible for aligning the project with market needs and developing the business strategy. She will also contribute to frontend development, focusing on a user-friendly interface.", img: "https://i.ibb.co/VZpYzy3/Whats-App-Image-2025-09-26-at-15-55-43-eed85144.jpg" },
            { name: "Ahmed Essam Wagdy", role: "Frontend Developer & Researcher", desc: "Responsible for implementing core features like the interactive map and API integrations. His research skills are crucial for finding the best technical solutions.", img: "https://i.ibb.co/rKYQGD4/Whats-App-Image-2025-09-26-at-1-11-41-AM.jpg" },
            { name: "Loay Ahmed Abo El-Maty", role: "Frontend Developer & Researcher", desc: "Responsible for developing features such as the animated weather graphics. He will also conduct research to support the technical implementation.", img: "https://i.ibb.co/39htsQ0/Whats-App-Image-2025-09-24-at-11-41-20-PM.jpg" },
            { name: "Ziad Mohamed Hamdy", role: "Social Media Specialist", desc: "Responsible for managing the project's public presence and communication strategy. He will handle social media updates and community engagement to build awareness.", img: "https://i.ibb.co/mC62Nmx/Whats-App-Image-2025-09-26-at-6-59-23-PM.jpg" },
        ];


        // --- TRANSLATIONS OBJECT ---
        const translations = {
            en: {
                appName: "Air Quality Monitor",
                navLogin: "Login",
                navSignup: "Sign Up",
                navHome: "Home",
                navMap: "Map",
                navTeam: "Our Team",
                navMission: "Our Mission",
                navAqiGuide: "AQI Guide",
                navSettings: "Settings",
                navLanguage: "Language",
                navTheme: "Theme",
                navTalkback: "Read on Hover",
                heroTitle: "Breathe Clearer. Live Better.",
                heroSubtitle: "Your real-time guide to the air you breathe. We provide live, accurate air quality data to help you make healthier decisions every day.",
                heroButton: "Launch Live Map",
                teamTitle: "Meet Our Team",
                teamSlogan: "Together, we build solutions for a better tomorrow.",
                missionTitle: "Our Mission: Earth's Health from a Celestial View",
                missionSubtitle: "A NASA Space Apps Challenge 2025 Project",
                missionChallengeName: "From EarthData to Action: Cloud Computing with Earth Observation Data for Predicting Cleaner, Safer Skies",
                missionDesc: "This project was born out of the NASA Space Apps Challenge Cairo 2025, marking the 11th local edition of this global event. Our goal is to leverage the power of data, inspired by space exploration, to bring crucial environmental information to your fingertips. By monitoring air quality, we aim to foster a healthier relationship between humanity and our home planet.",
                aqiGuideTitle: "Understanding the Air Quality Index (AQI)",
                aqiGuideDesc: "The AQI is your guide to understanding how clean or polluted the air is. Here's a quick breakdown of the levels:",
                namePlaceholder: "Full Name",
                emailPlaceholder: "Email",
                passwordPlaceholder: "Password",
                loginTitle: "Login to Your Account",
                loginButton: "Login",
                noAccount: "Don't have an account?",
                signupLink: "Sign up",
                signupTitle: "Create a New Account",
                signupButton: "Sign Up",
                hasAccount: "Already have an account?",
                loginLink: "Login",
                forgotPasswordLink: "Forgot Password?",
                forgotPasswordTitle: "Reset Password",
                forgotPasswordInstructions: "Enter your email and we'll send you a link to reset your password.",
                sendResetLinkButton: "Send Reset Link",
                resetEmailSent: "Password reset email sent! Please check your inbox and spam folder.",
                changePasswordTitle: "Change Password",
                currentPasswordPlaceholder: "Current Password for verification",
                newPasswordPlaceholder: "New Password (min. 6 characters)",
                changePasswordButton: "Update Password",
                passwordUpdateSuccess: "Password updated successfully!",
                passwordUpdateError: "Incorrect current password. Please try again.",
                menuEditProfile: "Edit Profile",
                editProfileTitle: "Edit Profile",
                editEmailInstructions: "To change your email, please enter your current password.",
                saveChangesButton: "Save Changes",
                profileUpdateSuccess: "Profile updated successfully!",
                menuHistory: "Search History",
                menuChangePassword: "Change Password",
                menuLogout: "Logout",
                searchPlaceholder: "Search for a city or place...",
                historyTitle: "Search History",
                noHistory: "Your search history is empty.",
                aboutTitle: "A Comprehensive Tool for Your Well-being",
                aboutSubtitle: "We combine air quality, weather data, and personalized features to give you a complete picture of your environment.",
                feature1Title: "Live Interactive Map",
                feature1Desc: "Our core feature is a dynamic world map. Click anywhere to get instant, real-time Air Quality Index (AQI) data from the nearest monitoring station. Track pollution levels in your city or anywhere you plan to travel.",
                feature2Title: "Detailed Data & Weather",
                feature2Desc: "Beyond the AQI number, our detailed panel shows you crucial weather information like temperature, humidity, and wind speed. This helps you understand how weather conditions affect air quality.",
                dataPanelAQI: "Air Quality Index (AQI)",
                dataPanelTemp: "Temp",
                dataPanelHumidity: "Humidity",
                dataPanelWind: "Wind",
                dataPanelHealthAdvice: "Health Advice:",
                updatedLabel: "Updated",
                footerText: "© 2024 All rights reserved for Digital Minds team",
                aqiStatusGood: "Good",
                aqiAdviceGood: "Air quality is excellent. Great day to be active outside!",
                aqiStatusModerate: "Moderate",
                aqiAdviceModerate: "Air quality is acceptable. Sensitive individuals may have symptoms.",
                aqiStatusUnhealthySensitive: "Unhealthy for Sensitive",
                aqiAdviceUnhealthySensitive: "Sensitive groups should reduce heavy exertion outdoors.",
                aqiStatusUnhealthy: "Unhealthy",
                aqiAdviceUnhealthy: "Everyone should reduce heavy exertion outdoors.",
                aqiStatusVeryUnhealthy: "Very Unhealthy",
                aqiAdviceVeryUnhealthy: "Health alert: Avoid all outdoor physical activity.",
                aqiStatusHazardous: "Hazardous",
                aqiAdviceHazardous: "Health warning: Everyone should stay indoors.",
                aqiStatusNoData: "No Data",
                aqiError: "AQI data not available for this location.",
                fetchError: "Failed to fetch all data. Please try again.",
                errorTitle: "Error",
                aiAssistantTitle: "AI Assistant",
                aiTyping: "AI is typing...",
                aiPlaceholder: "Ask about weather, AQI, or health advice...",
                getForecast: "Get Forecast",
                myHealth: "My Health",
                healthProfilePrompt: "Select any conditions for personalized advice:",
                healthAsthma: "Asthma",
                healthAllergies: "Allergies",
                healthHeart: "Heart Condition",
                healthLungs: "Lung Condition",
            },
            ar: {
                appName: "مراقب جودة الهواء",
                navLogin: "تسجيل الدخول",
                navSignup: "حساب جديد",
                navHome: "الرئيسية",
                navMap: "الخريطة",
                navTeam: "فريقنا",
                navMission: "مهمتنا",
                navAqiGuide: "دليل جودة الهواء",
                navSettings: "الإعدادات",
                navLanguage: "اللغة",
                navTheme: "المظهر",
                navTalkback: "القراءة عند المرور",
                heroTitle: "تنفس أنقى. عش أفضل.",
                heroSubtitle: "دليلك الفوري لجودة الهواء الذي تتنفسه. نحن نقدم بيانات دقيقة ومباشرة لمساعدتك على اتخاذ قرارات صحية كل يوم.",
                heroButton: "افتح الخريطة المباشرة",
                teamTitle: "تعرف على فريقنا",
                teamSlogan: "معًا، نبني حلولًا من أجل غد أفضل.",
                missionTitle: "مهمتنا: صحة الأرض من منظور سماوي",
                missionSubtitle: "مشروع مقدم لتحدي NASA Space Apps لعام 2025",
                missionChallengeName: "من بيانات الأرض إلى العمل: الحوسبة السحابية مع بيانات مراقبة الأرض للتنبؤ بسماء أنظف وأكثر أمانًا",
                missionDesc: "وُلد هذا المشروع من رحم تحدي NASA Space Apps القاهرة 2025، والذي يمثل النسخة المحلية الحادية عشرة من هذا الحدث العالمي. هدفنا هو تسخير قوة البيانات، المستوحاة من استكشاف الفضاء، لوضع المعلومات البيئية الحيوية في متناول يدك. من خلال مراقبة جودة الهواء، نطمح إلى تعزيز علاقة صحية بين الإنسانية وكوكبنا الأم.",
                aqiGuideTitle: "فهم مؤشر جودة الهواء (AQI)",
                aqiGuideDesc: "مؤشر جودة الهواء هو دليلك لفهم مدى نقاء أو تلوث الهواء. إليك شرح سريع للمستويات:",
                namePlaceholder: "الاسم الكامل",
                emailPlaceholder: "البريد الإلكتروني",
                passwordPlaceholder: "كلمة المرور",
                loginTitle: "تسجيل الدخول إلى حسابك",
                loginButton: "دخول",
                noAccount: "ليس لديك حساب؟",
                signupLink: "أنشئ حسابًا",
                signupTitle: "إنشاء حساب جديد",
                signupButton: "إنشاء حساب",
                hasAccount: "هل لديك حساب بالفعل؟",
                loginLink: "تسجيل الدخول",
                forgotPasswordLink: "هل نسيت كلمة المرور؟",
                forgotPasswordTitle: "إعادة تعيين كلمة المرور",
                forgotPasswordInstructions: "أدخل بريدك الإلكتروني وسنرسل لك رابطًا لإعادة تعيين كلمة المرور.",
                sendResetLinkButton: "أرسل رابط الاستعادة",
                resetEmailSent: "تم إرسال بريد إعادة تعيين كلمة المرور! يرجى التحقق من بريدك الوارد ومجلد الرسائل غير المرغوب فيها (Spam).",
                changePasswordTitle: "تغيير كلمة المرور",
                currentPasswordPlaceholder: "كلمة المرور الحالية للتحقق",
                newPasswordPlaceholder: "كلمة المرور الجديدة (6 أحرف على الأقل)",
                changePasswordButton: "تحديث كلمة المرور",
                passwordUpdateSuccess: "تم تحديث كلمة المرور بنجاح!",
                passwordUpdateError: "كلمة المرور الحالية غير صحيحة. يرجى المحاولة مرة أخرى.",
                menuEditProfile: "تعديل الملف الشخصي",
                editProfileTitle: "تعديل الملف الشخصي",
                saveChangesButton: "حفظ التغييرات",
                profileUpdateSuccess: "تم تحديث الملف الشخصي بنجاح!",
                menuHistory: "سجل البحث",
                menuChangePassword: "تغيير كلمة المرور",
                menuLogout: "تسجيل الخروج",
                searchPlaceholder: "ابحث عن مدينة أو مكان...",
                historyTitle: "سجل البحث",
                noHistory: "سجل البحث الخاص بك فارغ.",
                aboutTitle: "أداة شاملة لرفاهيتك",
                aboutSubtitle: "نحن نجمع بين بيانات جودة الهواء والطقس والميزات المخصصة لنمنحك صورة كاملة عن بيئتك.",
                feature1Title: "خريطة تفاعلية مباشرة",
                feature1Desc: "ميزتنا الأساسية هي خريطة عالمية ديناميكية. انقر في أي مكان للحصول على بيانات مؤشر جودة الهواء (AQI) الفورية في الوقت الفعلي من أقرب محطة مراقبة. تتبع مستويات التلوث في مدينتك أو أي مكان تخطط للسفر إليه.",
                feature2Title: "بيانات مفصلة والطقس",
                feature2Desc: "إلى جانب رقم مؤشر جودة الهواء، تعرض لك لوحة البيانات التفصيلية معلومات الطقس الهامة مثل درجة الحرارة والرطوبة وسرعة الرياح. يساعدك هذا على فهم كيفية تأثير الظروف الجوية على جودة الهواء.",
                dataPanelAQI: "مؤشر جودة الهواء",
                dataPanelTemp: "الحرارة",
                dataPanelHumidity: "الرطوبة",
                dataPanelWind: "الرياح",
                dataPanelHealthAdvice: "نصيحة صحية:",
                updatedLabel: "آخر تحديث",
                footerText: "© 2024 جميع الحقوق محفوظة لفريق Digital Minds",
                aqiStatusGood: "جيد",
                aqiAdviceGood: "جودة الهواء ممتازة. يوم رائع للنشاط في الخارج!",
                aqiStatusModerate: "متوسط",
                aqiAdviceModerate: "جودة الهواء مقبولة. قد يعاني الأفراد الحساسون من أعراض.",
                aqiStatusUnhealthySensitive: "غير صحي للحساسين",
                aqiAdviceUnhealthySensitive: "يجب على المجموعات الحساسة تقليل المجهود الشاق في الهواء الطلق.",
                aqiStatusUnhealthy: "غير صحي",
                aqiAdviceUnhealthy: "يجب على الجميع تقليل المجهود الشاق في الهواء الطلق.",
                aqiStatusVeryUnhealthy: "غير صحي للغاية",
                aqiAdviceVeryUnhealthy: "تنبيه صحي: تجنب كل الأنشطة البدنية في الهواء الطلق.",
                aqiStatusHazardous: "خطير",
                aqiAdviceHazardous: "تحذير صحي: يجب على الجميع البقاء في الداخل.",
                aqiStatusNoData: "لا توجد بيانات",
                aqiError: "بيانات جودة الهواء غير متوفرة لهذا الموقع.",
                fetchError: "فشل جلب جميع البيانات. يرجى المحاولة مرة أخرى.",
                errorTitle: "خطأ",
                aiAssistantTitle: "المساعد الذكي",
                aiTyping: "الذكاء الاصطناعي يكتب...",
                aiPlaceholder: "اسأل عن الطقس، جودة الهواء، أو نصائح صحية...",
                getForecast: "احصل على التوقعات",
                myHealth: "حالتي الصحية",
                healthProfilePrompt: "اختر أي حالة للحصول على نصائح مخصصة:",
                healthAsthma: "الربو",
                healthAllergies: "الحساسية",
                healthHeart: "أمراض القلب",
                healthLungs: "أمراض الرئة",
            }
        };

        async function askGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            const headers = { 'Content-Type': 'application/json' };
            const body = JSON.stringify({
                contents: [{
                    parts: [{ text: prompt }]
                }]
            });

            try {
                const response = await fetch(url, { method: 'POST', headers, body });
                if (!response.ok) {
                    console.error("Gemini API Error:", response.status, await response.text());
                    return "Sorry, I'm having trouble connecting to my brain right now. Please try again later.";
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "An error occurred while trying to reach the AI assistant.";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- UI ELEMENTS ---
            const landingPage = document.getElementById('landing-page');
            const pageContent = document.getElementById('page-content');
            const mapView = document.getElementById('map-view');
            const mapContainer = document.getElementById('map-container');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const menuBtn = document.getElementById('menu-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const themeToggleSidebar = document.getElementById('theme-toggle-sidebar');
            const talkbackToggle = document.getElementById('talkback-toggle');

            // AI Assistant UI Elements
            const aiAssistantBtn = document.getElementById('ai-assistant-btn');
            const aiModal = document.getElementById('ai-modal');
            const closeAiModalBtn = document.getElementById('close-ai-modal');
            const aiChatWindow = document.getElementById('ai-chat-window');
            const aiInputForm = document.getElementById('ai-input-form');
            const aiUserInput = document.getElementById('ai-user-input');
            const aiLoadingIndicator = document.getElementById('ai-loading-indicator');
            const getForecastBtn = document.getElementById('get-forecast-btn');
            const healthProfileBtn = document.getElementById('health-profile-btn');
            const healthProfileSection = document.getElementById('health-profile-section');

            let mapInitialized = false;
            let map = null;
            let currentLocationData = null; // For AI context
            let speechVoices = [];
            let isTalkbackEnabled = false;
            let currentHighlight = null;
            const allViews = [landingPage, mapView, pageContent];
            const pageViews = {}; // Team page is now on landing page
            const landingPageAnchors = ['#mission', '#aqi-guide', '#about-features', '#team'];

            // --- AI CHAT LOGIC ---
            const openAiModal = () => {
                aiModal.classList.remove('hidden');
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                const welcomeMessage = currentLang === 'ar'
                    ? "أهلاً بك! يمكنك سؤالي عن توقعات الطقس وجودة الهواء، أو طلب نصائح صحية شخصية بناءً على البيانات المتاحة."
                    : "Welcome! Ask me for a weather and air quality forecast, or for personalized health advice based on the data.";
                appendMessage(welcomeMessage, "ai");
            };

            const closeAiModal = () => {
                aiModal.classList.add('hidden');
                aiChatWindow.innerHTML = ''; // Clear chat history on close
            };

            const appendMessage = (text, sender) => {
                const messageDiv = document.createElement('div');
                const bubbleDiv = document.createElement('div');
                bubbleDiv.textContent = text;
                bubbleDiv.className = `p-3 rounded-lg max-w-[85%] ${sender === 'user' ? 'bg-indigo-600 text-white self-end' : 'bg-gray-700 text-gray-200 self-start'}`;
                messageDiv.className = 'flex flex-col mb-3';
                messageDiv.appendChild(bubbleDiv);
                aiChatWindow.appendChild(messageDiv);
                aiChatWindow.scrollTop = aiChatWindow.scrollHeight; // Auto-scroll
            };

            healthProfileBtn.addEventListener('click', () => {
                healthProfileSection.classList.toggle('hidden');
            });

            aiInputForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = aiUserInput.value.trim();
                if (!userInput) return;

                appendMessage(userInput, 'user');
                aiUserInput.value = '';
                aiLoadingIndicator.classList.remove('hidden');

                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                const langInstructions = currentLang === 'ar'
                    ? 'The user prefers Arabic. Your entire response must be in Arabic.'
                    : 'The user prefers English. Your entire response must be in English.';

                const selectedConditions = Array.from(document.querySelectorAll('.health-condition:checked')).map(cb => cb.value);

                // System-level instruction for the AI's persona
                let systemPrompt = "You are a helpful AI assistant for the 'Air Quality Monitor' web application. Your role is to interpret environmental data and provide clear, actionable advice. Be friendly and encouraging.";

                // Contextual data from the application
                let contextPrompt = "";
                if (currentLocationData) {
                    const { aqiData, weatherData } = currentLocationData;
                    const aqi = aqiData?.aqi || 'N/A';
                    const temp = weatherData?.main?.temp ? `${Math.round(weatherData.main.temp)}°C` : 'N/A';
                    const weather = weatherData?.weather?.[0]?.description || 'N/A';
                    const city = weatherData?.name || aqiData?.city?.name || 'the current location';
                    contextPrompt = `The user is currently viewing data for ${city}. The Air Quality Index (AQI) is ${aqi}. The weather is ${weather} with a temperature of ${temp}.`;
                } else {
                    contextPrompt = "The user has not selected a location on the map yet.";
                }

                // User-specific information
                let userPrompt = `The user's question is: "${userInput}".`;
                if (selectedConditions.length > 0) {
                    const conditionsText = selectedConditions.join(', ');
                    userPrompt += ` They have indicated the following health conditions: ${conditionsText}. Please tailor your advice accordingly.`;
                }

                // Assemble the final prompt
                const fullPrompt = `${systemPrompt}\n\n${contextPrompt}\n\n${userPrompt}\n\n${langInstructions}`;

                const aiResponse = await askGemini(fullPrompt);

                aiLoadingIndicator.classList.add('hidden');
                appendMessage(aiResponse, 'ai');
            });

            aiAssistantBtn.addEventListener('click', openAiModal);
            closeAiModalBtn.addEventListener('click', closeAiModal);

            getForecastBtn.addEventListener('click', async () => {
                if (!currentLocationData) {
                    appendMessage("Please select a location on the map first to get a forecast.", "ai");
                    return;
                }

                const { aqiData, weatherData } = currentLocationData;
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                const langInstructions = currentLang === 'ar' ? 'Please provide the forecast in Arabic.' : 'Please provide the forecast in English.';

                const prompt = `
                    Based on the following real-time data for ${weatherData?.name || 'the selected location'}:
                    - Air Quality Index (AQI): ${aqiData?.aqi || 'N/A'}
                    - Temperature: ${weatherData?.main?.temp ? Math.round(weatherData.main.temp) + '°C' : 'N/A'}
                    - Weather: ${weatherData?.weather?.[0]?.description || 'N/A'}
                    - Humidity: ${weatherData?.main?.humidity ? weatherData.main.humidity + '%' : 'N/A'}
                    - Wind Speed: ${weatherData?.wind?.speed ? Math.round(weatherData.wind.speed * 3.6) + ' km/h' : 'N/A'}

                    Please provide a simple, user-friendly forecast for the next 24 hours. Include predictions for air quality and weather. Also, give one or two general health recommendations based on this data.
                    ${langInstructions}
                `;

                const forecastRequestText = currentLang === 'ar' ? 'جاري إنشاء التوقعات بناءً على البيانات الحالية...' : 'Generating forecast based on current data...';
                appendMessage(forecastRequestText, 'user');
                aiLoadingIndicator.classList.remove('hidden');

                const aiResponse = await askGemini(prompt);

                aiLoadingIndicator.classList.add('hidden');
                appendMessage(aiResponse, 'ai');
            });


            // --- TEXT-TO-SPEECH VOICE LOADER ---
            function loadVoices() {
                speechVoices = speechSynthesis.getVoices();
            }
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }

            // --- RENDER DYNAMIC CONTENT ---
            function renderTeam() {
                const teamContainer = document.querySelector('#team .grid');
                if(!teamContainer) return;
                teamContainer.innerHTML = ''; // Clear existing
                teamMembers.forEach((member, index) => {
                    const card = document.createElement('div');
                    card.className = "team-card glass-panel p-6 rounded-lg text-center animate-on-scroll";
                    card.style.transitionDelay = `${index * 100}ms`;
                    card.innerHTML = `
                        <img src="${member.img}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/E2E8F0/4A5568?text=${member.name.charAt(0)}';" alt="Photo of ${member.name}" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-indigo-500/50 object-cover">
                        <h3 class="text-xl font-bold text-white">${member.name}</h3>
                        <p class="text-indigo-400 font-semibold">${member.role}</p>
                        <p class="text-gray-400 mt-2 text-sm">${member.desc}</p>
                    `;
                    teamContainer.appendChild(card);
                });
            }

            function renderAqiGuide() {
                const aqiContainer = document.querySelector('#aqi-guide .grid');
                if (!aqiContainer) return;
                aqiContainer.innerHTML = '';
                const aqiLevels = [
                    { range: '0 - 50', statusKey: 'aqiStatusGood', adviceKey: 'aqiAdviceGood', color: '#22c55e' },
                    { range: '51 - 100', statusKey: 'aqiStatusModerate', adviceKey: 'aqiAdviceModerate', color: '#facc15' },
                    { range: '101 - 150', statusKey: 'aqiStatusUnhealthySensitive', adviceKey: 'aqiAdviceUnhealthySensitive', color: '#f97316' },
                    { range: '151 - 200', statusKey: 'aqiStatusUnhealthy', adviceKey: 'aqiAdviceUnhealthy', color: '#ef4444' },
                    { range: '201 - 300', statusKey: 'aqiStatusVeryUnhealthy', adviceKey: 'aqiAdviceVeryUnhealthy', color: '#a855f7' },
                    { range: '301+', statusKey: 'aqiStatusHazardous', adviceKey: 'aqiAdviceHazardous', color: '#7f1d1d' },
                ];
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';

                aqiLevels.forEach((level, index) => {
                    const card = document.createElement('div');
                    card.className = 'glass-panel p-4 rounded-lg aqi-level-card animate-on-scroll';
                    card.style.borderColor = level.color;
                    card.style.transitionDelay = `${index * 100}ms`;
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <p class="font-bold text-lg text-white">${translations[currentLang][level.statusKey]}</p>
                            <p class="font-black text-xl" style="color: ${level.color};">${level.range}</p>
                        </div>
                        <p class="text-gray-400 text-sm">${translations[currentLang][level.adviceKey]}</p>
                    `;
                    aqiContainer.appendChild(card);
                });
            }
            
            // --- Create Shooting Stars ---
            const shootingStarsContainer = document.getElementById('shooting-stars-container');
            if (shootingStarsContainer) {
                const numberOfStars = 15;
                for (let i = 0; i < numberOfStars; i++) {
                    let star = document.createElement('div');
                    star.classList.add('shooting-star');
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 10}s`;
                    star.style.animationDuration = `${(Math.random() * 2) + 1}s`; // Duration between 1s and 3s
                    shootingStarsContainer.appendChild(star);
                }
            }
            
            renderTeam();
            renderAqiGuide();
            
            // --- THEME/DARK MODE LOGIC ---
            const applyTheme = (theme) => {
                if (theme === 'light') {
                    document.documentElement.classList.add('light');
                    themeToggleSidebar.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>`; // Moon icon
                } else { // 'dark' is default
                    document.documentElement.classList.remove('light');
                    themeToggleSidebar.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 15a5 5 0 100-10 5 5 0 000 10zM10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm0 14a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-7-8a1 1 0 011-1h1a1 1 0 110 2H4a1 1 0 01-1-1zm14 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1zm-2.929-5.071a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707zm-9.142 9.142a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414l.707.707zm9.142 0a1 1 0 01-1.414 1.414l.707.707a1 1 0 011.414-1.414l-.707-.707zm-9.142-9.142a1 1 0 01-1.414 1.414l.707.707a1 1 0 011.414-1.414l-.707-.707z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`; // Sun icon
                }
            };

            const toggleTheme = () => {
                const currentTheme = localStorage.getItem('theme') || 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            };

            themeToggleSidebar.addEventListener('click', toggleTheme);

            const initialTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(initialTheme);
            
            // --- SECURITY HELPER ---
            const sanitizeInput = (input) => {
                const div = document.createElement('div');
                div.textContent = input;
                return div.innerHTML;
            };

            // --- LANGUAGE SWITCHER LOGIC ---
            const setLanguage = (lang) => {
                speechSynthesis.cancel();
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                
                document.body.classList.remove('lang-en', 'lang-ar');
                document.body.classList.add('lang-' + lang);

                document.querySelectorAll('[data-lang-key]').forEach(element => {
                    const key = element.getAttribute('data-lang-key');
                    const translation = translations[lang][key];
                    if (translation) {
                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            element.setAttribute('placeholder', translation);
                        } else {
                            element.textContent = translation;
                        }
                    }
                });
                
                if (map) {
                    const geocoderControl = document.querySelector('.leaflet-control-geocoder-form input');
                    if (geocoderControl) {
                        geocoderControl.placeholder = translations[lang].searchPlaceholder;
                    }
                }
                
                renderAqiGuide(); // Re-render AQI guide with new language
                localStorage.setItem('preferredLanguage', lang);
                updateLangButtons(lang);
            };

            const updateLangButtons = (lang) => {
                const langEnBtnSidebar = document.getElementById('lang-en-sidebar');
                const langArBtnSidebar = document.getElementById('lang-ar-sidebar');
                if (lang === 'ar') {
                    langArBtnSidebar.classList.add('bg-indigo-600', 'text-white');
                    langEnBtnSidebar.classList.remove('bg-indigo-600', 'text-white');
                } else {
                    langEnBtnSidebar.classList.add('bg-indigo-600', 'text-white');
                    langArBtnSidebar.classList.remove('bg-indigo-600', 'text-white');
                }
            };
            
            document.getElementById('lang-en-sidebar').addEventListener('click', () => setLanguage('en'));
            document.getElementById('lang-ar-sidebar').addEventListener('click', () => setLanguage('ar'));
            
            const preferredLanguage = localStorage.getItem('preferredLanguage') || 'en';
            setLanguage(preferredLanguage);

            // --- Scroll Animations ---
            const scrollElements = document.querySelectorAll('.animate-on-scroll');
            const elementInView = (el, offset = 0) => {
                const elementTop = el.getBoundingClientRect().top;
                return (
                    elementTop <= 
                    (window.innerHeight || document.documentElement.clientHeight) - offset
                );
            };

            const handleScrollAnimation = () => {
                scrollElements.forEach((el) => {
                    if(elementInView(el, 100)) {
                        el.classList.add('is-visible');
                    }
                })
            }
            window.addEventListener('scroll', handleScrollAnimation);


            // --- VIEW MANAGEMENT ---
            function showPage(hash) {
                speechSynthesis.cancel();
                allViews.forEach(v => v.classList.add('hidden'));
                Object.values(pageViews).forEach(v => v.classList.add('hidden'));
                
                if (hash === '#map') {
                    mapView.classList.remove('hidden');
                    if (!mapInitialized) {
                        initializeMapApp();
                        mapInitialized = true;
                    }
                    setTimeout(() => { if (map) map.invalidateSize(); }, 0);
                } else {
                    landingPage.classList.remove('hidden');
                    if (hash && (landingPageAnchors.includes(hash))) {
                         const targetElement = document.getElementById(hash.substring(1));
                         if (targetElement) {
                             setTimeout(() => targetElement.scrollIntoView({ behavior: 'smooth' }), 0);
                         }
                    } else {
                        window.scrollTo(0, 0);
                    }
                }
                
                setTimeout(handleScrollAnimation, 100);
            }
            
             // --- "TALKBACK" TEXT-TO-SPEECH LOGIC ---
            const speakText = (element) => {
                if (!isTalkbackEnabled || !element || !element.innerText.trim()) {
                    return;
                }

                speechSynthesis.cancel(); // Stop any previous speech

                const textToRead = element.innerText;
                const utterance = new SpeechSynthesisUtterance(textToRead);
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                const langCode = currentLang === 'ar' ? 'ar-SA' : 'en-US';
                const langShortCode = currentLang === 'ar' ? 'ar' : 'en';

                let selectedVoice = speechVoices.find(voice => voice.lang === langCode);
                if (!selectedVoice) {
                    selectedVoice = speechVoices.find(voice => voice.lang.startsWith(langShortCode));
                }

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                } else {
                    utterance.lang = langCode;
                }
                
                speechSynthesis.speak(utterance);
            };

            const handleMouseOver = (event) => {
                if (!isTalkbackEnabled) return;
                
                const target = event.target.closest('h1, h2, h3, h4, p, a, button, [data-readable]');
                if (target && target !== currentHighlight) {
                     if (currentHighlight) {
                        currentHighlight.classList.remove('talkback-highlight');
                    }
                    currentHighlight = target;
                    currentHighlight.classList.add('talkback-highlight');
                    speakText(target);
                }
            };

            const handleMouseOut = (event) => {
                if (currentHighlight) {
                    currentHighlight.classList.remove('talkback-highlight');
                    currentHighlight = null;
                    speechSynthesis.cancel();
                }
            };

            talkbackToggle.addEventListener('change', () => {
                isTalkbackEnabled = talkbackToggle.checked;
                if(isTalkbackEnabled) {
                    document.body.addEventListener('mouseover', handleMouseOver);
                    document.body.addEventListener('mouseout', handleMouseOut);
                } else {
                    document.body.removeEventListener('mouseover', handleMouseOver);
                    document.body.removeEventListener('mouseout', handleMouseOut);
                    speechSynthesis.cancel();
                     if (currentHighlight) {
                        currentHighlight.classList.remove('talkback-highlight');
                        currentHighlight = null;
                    }
                }
            });


            document.getElementById('launch-map-btn').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = '#map';
            });
            document.getElementById('home-logo-link').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = '';
            });
            
            window.addEventListener('hashchange', () => showPage(window.location.hash));
            showPage(window.location.hash); // Initial load


             // Sidebar Toggle
            const closeSidebar = () => document.body.classList.remove('sidebar-open');
            menuBtn.addEventListener('click', () => document.body.classList.add('sidebar-open'));
            closeSidebarBtn.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    const href = link.getAttribute('href');
                    if (!href.startsWith('#') || href === '#') {
                        // Let default behavior for external links
                    } else {
                        // For all internal hash links, prevent default and let our logic handle it
                        e.preventDefault();
                        window.location.hash = href;
                    }
                    closeSidebar();
                });
            });

            // --- MAP APPLICATION LOGIC (INITIALIZED ON DEMAND) ---
            function initializeMapApp() {
                // API KEYS
                const WAQI_API_KEY = "928a43b09b68edba7abf27fda1fa9a9a754fd8c0";
                const OPENWEATHER_API_KEY = "8e8cc4c4a2a0e8af0a9a96d4d0277b58";
                
                let currentCityData = {}; 

                // Inject map UI elements
                mapContainer.innerHTML = `
                    <div id="map"></div>
                    <button id="locate-btn" class="absolute bottom-4 left-4 z-[1000] p-3 rounded-full shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" title="Find my location">
                        <svg id="locate-icon" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
                    </button>
                    <div id="data-panel" class="absolute top-[100px] sm:top-24 left-2 right-2 sm:left-auto sm:right-4 sm:w-80 z-[1000] glass-panel p-4 rounded-lg hidden" data-readable="true">
                        <div id="loading" class="flex justify-center items-center h-48"><div class="loader"></div></div>
                        <div id="data-content" class="hidden">
                            <button id="close-panel-btn" class="absolute top-2 right-2 text-gray-400 hover:text-white z-10 p-1 rounded-full hover:bg-gray-700"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button>
                            <h2 id="city-name" class="text-xl font-bold text-white pr-6">...</h2>
                            <p id="update-time" class="text-xs text-gray-400">...</p>
                            <hr class="my-3 border-gray-700">
                            <div class="text-center">
                                <p class="text-sm text-gray-400" data-lang-key="dataPanelAQI">Air Quality Index (AQI)</p>
                                <div id="aqi-value" class="text-6xl font-bold my-2 text-white">--</div>
                                <div id="aqi-status" class="px-3 py-1 text-white rounded-full text-sm inline-block bg-gray-600">...</div>
                            </div>
                            <div id="weather-animation-container" class="relative h-24 my-2 overflow-hidden rounded-lg">
                                <div id="weather-animation"></div>
                            </div>
                            <p id="weather-description" class="text-center text-lg capitalize mb-2 text-white"></p>
                            <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                                <div><p class="text-xs text-gray-400" data-lang-key="dataPanelTemp">Temp</p><p id="temp-value" class="font-bold text-lg text-white">--°C</p></div>
                                <div><p class="text-xs text-gray-400" data-lang-key="dataPanelHumidity">Humidity</p><p id="humidity-value" class="font-bold text-lg text-white">--%</p></div>
                                <div><p class="text-xs text-gray-400" data-lang-key="dataPanelWind">Wind</p><p id="wind-value" class="font-bold text-lg text-white">-- km/h</p></div>
                            </div>
                            <div class="mt-4 bg-gray-900/50 p-2 rounded-lg">
                                <h4 class="font-bold text-sm text-white" data-lang-key="dataPanelHealthAdvice">Health Advice:</h4>
                                <p id="forecast-text" class="text-xs text-gray-300">Analyzing data...</p>
                            </div>
                        </div>
                    </div>
                `;

                // Map UI element references
                const dataPanel = document.getElementById('data-panel');
                const loadingDiv = document.getElementById('loading');
                const dataContentDiv = document.getElementById('data-content');
                const cityNameEl = document.getElementById('city-name');
                const updateTimeEl = document.getElementById('update-time');
                const aqiValueEl = document.getElementById('aqi-value');
                const aqiStatusEl = document.getElementById('aqi-status');
                const weatherAnimationEl = document.getElementById('weather-animation');
                const weatherDescriptionEl = document.getElementById('weather-description');
                const tempValueEl = document.getElementById('temp-value');
                const humidityValueEl = document.getElementById('humidity-value');
                const windValueEl = document.getElementById('wind-value');
                const forecastTextEl = document.getElementById('forecast-text');
                
                // Map Initialization
                map = L.map('map').setView([26.8206, 30.8025], 6); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                let marker = L.marker([26.8206, 30.8025], { opacity: 0 }).addTo(map);

                const currentMapLang = localStorage.getItem('preferredLanguage') || 'en';
                L.Control.geocoder({
                    defaultMarkGeocode: false,
                    placeholder: translations[currentMapLang].searchPlaceholder,
                    geocoder: L.Control.Geocoder.nominatim({
                        geocodingQueryParams: { "accept-language": "ar,en" } 
                    })
                }).on('markgeocode', function(e) {
                    const { center, name } = e.geocode;
                    map.setView(center, 13);
                    marker.setLatLng(center).setOpacity(1);
                    fetchAllDataForLocation(center.lat, center.lng);
                }).addTo(map);

                // --- DATA FETCHING & UI LOGIC ---
                const fetchAllDataForLocation = async (lat, lng) => {
                    speechSynthesis.cancel();
                    dataPanel.classList.remove('hidden');
                    loadingDiv.classList.remove('hidden');
                    dataContentDiv.classList.add('hidden');
                    
                    const currentLang = localStorage.getItem('preferredLanguage') || 'en';

                    const results = await Promise.allSettled([
                        fetchAqiData(lat, lng), 
                        fetchWeatherData(lat, lng, currentLang)
                    ]);

                    const aqiResult = results[0];
                    const weatherResult = results[1];

                    const aqiData = aqiResult.status === 'fulfilled' ? aqiResult.value : null;
                    const weatherData = weatherResult.status === 'fulfilled' ? weatherResult.value : null;

                    if (aqiResult.status === 'rejected') console.error("AQI Fetch Error:", aqiResult.reason);
                    if (weatherResult.status === 'rejected') console.error("Weather Fetch Error:", weatherResult.reason);
                    
                    if (!aqiData && !weatherData) {
                        handleError(translations[currentLang].fetchError);
                    } else {
                        updateUIPanel({ aqiData, weatherData, lat, lng });
                    }
                };
                
                const fetchAqiData = async (lat, lng) => {
                    const url = `https://api.waqi.info/feed/geo:${lat};${lng}/?token=${WAQI_API_KEY}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Could not fetch AQI data.');
                    const data = await response.json();
                    if (data.status !== "ok") throw new Error(data.data || 'No station found.');
                    return data.data;
                };

                const fetchWeatherData = async (lat, lng, lang) => {
                    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=${lang}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Could not fetch weather data.');
                    return await response.json();
                };

                const updateWeatherAnimation = (weatherId) => {
                    weatherAnimationEl.innerHTML = ''; // Clear previous animation
                    if (weatherId === 800) { // Clear
                        weatherAnimationEl.innerHTML = '<div class="sun"></div>';
                    } else if (weatherId >= 801 && weatherId <= 804) { // Clouds
                        weatherAnimationEl.innerHTML = '<div class="cloud"></div><div class="cloud c2"></div>';
                    } else if ((weatherId >= 300 && weatherId <= 321) || (weatherId >= 500 && weatherId <= 531)) { // Drizzle & Rain
                        let rainHTML = '<div class="cloud"></div><div class="rain">';
                        for(let i=0; i<20; i++) {
                            const left = Math.random() * 100;
                            const delay = Math.random() * 2;
                            rainHTML += `<div style="left: ${left}%; animation-delay: ${delay}s;"></div>`;
                        }
                        rainHTML += '</div>';
                        weatherAnimationEl.innerHTML = rainHTML;
                    } else if (weatherId >= 200 && weatherId <= 232) { // Thunderstorm
                        let rainHTML = '<div class="cloud" style="background: #888;"></div><div class="thunder"></div><div class="rain">';
                        for(let i=0; i<20; i++) {
                            const left = Math.random() * 100;
                            const delay = Math.random() * 2;
                            rainHTML += `<div style="left: ${left}%; animation-delay: ${delay}s;"></div>`;
                        }
                        rainHTML += '</div>';
                        weatherAnimationEl.innerHTML = rainHTML;
                    } else if (weatherId >= 600 && weatherId <= 622) { // Snow
                        let snowHTML = '<div class="cloud"></div><div class="snow">';
                        for(let i=0; i<20; i++) {
                            const left = Math.random() * 100;
                            const delay = Math.random() * 5;
                             const duration = (Math.random() * 3) + 4; // 4 to 7 seconds
                            snowHTML += `<div style="left: ${left}%; animation-delay: ${delay}s; animation-duration: ${duration}s;"></div>`;
                        }
                        snowHTML += '</div>';
                        weatherAnimationEl.innerHTML = snowHTML;
                    } else if (weatherId >= 701 && weatherId <= 781) { // Mist, Fog, etc.
                        weatherAnimationEl.innerHTML = '<div class="mist"><div class="m1"></div><div class="m2"></div></div>';
                    } else {
                         weatherAnimationEl.innerHTML = '<div class="cloud"></div>'; // Default to cloudy
                    }
                };
                
                const getAqiStatus = (aqi) => {
                     if (aqi <= 50) return { statusKey: "aqiStatusGood", adviceKey: "aqiAdviceGood", color: "#22c55e" };
                     if (aqi <= 100) return { statusKey: "aqiStatusModerate", adviceKey: "aqiAdviceModerate", color: "#facc15" };
                     if (aqi <= 150) return { statusKey: "aqiStatusUnhealthySensitive", adviceKey: "aqiAdviceUnhealthySensitive", color: "#f97316" };
                     if (aqi <= 200) return { statusKey: "aqiStatusUnhealthy", adviceKey: "aqiAdviceUnhealthy", color: "#ef4444" };
                     if (aqi <= 300) return { statusKey: "aqiStatusVeryUnhealthy", adviceKey: "aqiAdviceVeryUnhealthy", color: "#a855f7" };
                     return { statusKey: "aqiStatusHazardous", adviceKey: "aqiAdviceHazardous", color: "#7f1d1d" };
                };

                const updateUIPanel = ({ aqiData, weatherData, lat, lng }) => {
                    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                    
                    // Store data for AI context
                    currentLocationData = { aqiData, weatherData };
                    getForecastBtn.classList.remove('hidden');

                    cityNameEl.textContent = weatherData?.name || aqiData?.city?.name || 'Unknown Location';

                    if (aqiData && aqiData.time) {
                        const locale = currentLang === 'ar' ? 'ar-EG' : 'en-US';
                        const localizedDate = new Date(aqiData.time.s * 1000).toLocaleString(locale, {
                            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                        });
                        updateTimeEl.textContent = `${translations[currentLang].updatedLabel}: ${localizedDate}`;
                        
                        aqiValueEl.textContent = aqiData.aqi;
                        const { statusKey, adviceKey, color } = getAqiStatus(aqiData.aqi);
                        aqiStatusEl.textContent = translations[currentLang][statusKey];
                        aqiStatusEl.style.backgroundColor = color;
                        forecastTextEl.textContent = translations[currentLang][adviceKey];
                    } else {
                        handleError(translations[currentLang].aqiError);
                    }

                    if (weatherData && weatherData.weather) {
                        updateWeatherAnimation(weatherData.weather[0].id);
                        weatherDescriptionEl.textContent = weatherData.weather[0].description;
                    }

                    if (weatherData && weatherData.main) {
                        tempValueEl.textContent = `${Math.round(weatherData.main.temp)}°C`;
                        humidityValueEl.textContent = `${weatherData.main.humidity}%`;
                        windValueEl.textContent = `${Math.round(weatherData.wind.speed * 3.6)} km/h`;
                    }
                    loadingDiv.classList.add('hidden');
                    dataContentDiv.classList.remove('hidden');
                };
                
                const handleError = (message) => {
                    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                    cityNameEl.textContent = translations[currentLang].errorTitle;
                    updateTimeEl.textContent = "";
                    aqiValueEl.textContent = "N/A";
                    aqiStatusEl.textContent = translations[currentLang].aqiStatusNoData;
                    aqiStatusEl.style.backgroundColor = "#9ca3af";
                    forecastTextEl.textContent = message;
                    weatherDescriptionEl.textContent = "";
                    weatherAnimationEl.innerHTML = "";
                    loadingDiv.classList.add('hidden');
                    dataContentDiv.classList.remove('hidden');
                };

                map.on('click', function(e) {
                    const { lat, lng } = e.latlng;
                    marker.setLatLng(e.latlng).setOpacity(1);
                    fetchAllDataForLocation(lat, lng);
                    const geocoder = L.Control.Geocoder.nominatim();
                    geocoder.reverse(e.latlng, map.options.crs.scale(map.getZoom()), (results) => {
                        if (results && results.length > 0) {
                            saveSearchToHistory({ name: results[0].name, lat, lng });
                        }
                    });
                });
                
                document.getElementById('close-panel-btn').addEventListener('click', () => {
                    speechSynthesis.cancel();
                    dataPanel.classList.add('hidden');
                });
                document.getElementById('locate-btn').addEventListener('click', () => map.locate({setView: true, maxZoom: 13}));
                map.on('locationfound', (e) => {
                    marker.setLatLng(e.latlng).setOpacity(1);
                    fetchAllDataForLocation(e.latlng.lat, e.latlng.lng);
                });
                map.on('locationerror', (e) => console.error("Location Error: ", e.message));
            }
        });
    </script>
</body>
</html>
